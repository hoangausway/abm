function t(){return void 0!==globalThis.document}function e(){return void 0!==globalThis.WorkerGlobalScope}function r(){return void 0!==globalThis.Deno}function s(t=1e3){return new Promise((e=>{setTimeout(e,t)}))}async function i(t,e=-1,r=0){let i=0;for(;i++!==e;)t(i-1),await s(r)}let n=!1;function o(t,e="number",r="Function"){if(n)return;if(typeof t!==e)throw new Error(`${r} expected a ${e}, got ${t}`)}const a=new Set;function h(t,e=!1){a.has(t)||(e?console.warn(t):console.log(t),a.add(t))}function l(t){h(t,!0)}const c=Math.PI;function u(t){return Math.floor(Math.random()*t)}function d(t,e){return t+Math.floor(Math.random()*(e-t))}function m(t){return Math.random()*t}function p(t,e){return t+Math.random()*(e-t)}function g(t=123456){t%=2147483647,Math.random=()=>((t=16807*t%2147483647)-1)/2147483646}function f(t,e=4){if(0===Math.abs(t))return 0;if(Array.isArray(t))return t.map((t=>f(t,e)));const r=10**e;return Math.round(t*r)/r}const y=t=>0==(t&t-1);function x(t,e){return(t%e+e)%e}const w=(t,e,r)=>e+x(t-e,r-e);function b(t,e,r){return t<e?e:t>r?r:t}const M=(t,e,r)=>e<=t&&t<=r,v=(t,e,r)=>t<=e?t+(e-t)*r:t-(t-e)*r;function z(t,e,r){if(e===r)throw Error("lerpScale: lo === hi");return((t=b(t,e,r))-e)/(r-e)}const _=180/Math.PI,S=Math.PI/180;function C(t){return P(t*S)}function A(t){return E(t*_)}function E(t){return x(t,360)}function P(t){return x(t,2*c)}function O(t){return E(90-t*_)}function k(t,e){return E(t)===E(e)}const I=k;function T(t,e){let r=P(t-e);return r>c&&(r-=2*c),r}function R(t,e){let r=E(t-e);return r>180&&(r-=360),r}function X(t,e){return-R(t,e)}function j(t,e,r,s){return Math.atan2(s-e,r-t)}function F(t,e,r,s,i,n,o){if(Y(n,o,t,e)>r*r)return!1;const a=j(n,o,t,e);return s/2>=Math.abs(T(i,a))}const Y=(t,e,r,s)=>(t-r)**2+(e-s)**2,D=(t,e,r,s)=>Math.sqrt(Y(t,e,r,s)),N=(t,e,r,s,i,n)=>(t-s)**2+(e-i)**2+(r-n)**2,L=(t,e,r,s,i,n)=>Math.sqrt(N(t,e,r,s,i,n));function U(t,e=0,r=!0){let s=r;const i=["rectCache"];return JSON.stringify(t,((t,e)=>{if(i.includes(t))return;return Array.isArray(e)&&e.length>0&&Number.isInteger(e[0].id)&&!s?e.map((t=>t.id)):(s=!1,e)}),e)}const $=t=>t,B=t=>e=>e[t];function W(t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function V(t,e){const r=t.indexOf(e);if(-1===r)throw Error(`removeArrayItem: ${e} not in array`);return t.splice(r,1),t}const q=t=>t.map((t=>`${t}`)).join(",");function Z(t,e){if(t.slice)for(let r=0,s=t.length;r<s;r++)e(t[r],r,t);else Object.keys(t).forEach((r=>e(t[r],r,t)))}function G(t,e,r=[]){for(let s=0;s<t;s++)e(s,r);return r}function H(t,e,r){for(let s=0;s<t;s+=e)r(s)}function J(t,e){const r=t.constructor;if(r===Array)return t.concat(_t(e,Array));const s=new r(t.length+e.length);return s.set(t),s.set(e,t.length),s}function Q(t){return t[u(t.length)]}function K(t,e){if(t.length<2)throw Error("otherOneOf: array.length < 2");let r;do{r=Q(t)}while(e===r);return r}const tt=t=>Q(Object.keys(t)),et=t=>t[tt(t)];function rt(t,e,r=!0){"string"==typeof e&&(e=B(e));const s=(t,r)=>e(t)-e(r);return t.sort(((t,e)=>r?s(t,e):-s(t,e)))}function st(t){for(let e=t.length-1;e>0;e--){const r=u(e);[t[r],t[e]]=[t[e],t[r]]}return t}function it(t,e,r){if(r<=1)throw Error("floatRamp: numItems must be > 1");const s=[];for(let i=0;i<r;i++)s.push(t+i/(r-1)*(e-t));return s}function nt(t,e,r=e-t+1){return it(t,e,r).map((t=>Math.round(t)))}const ot=t=>t.reduce(((t,e)=>Math.max(t,e))),at=t=>t.reduce(((t,e)=>Math.min(t,e)));function ht(t){return!!gt(t)&&Object.values(t).every((t=>vt(t)))}function lt(t,e,r){const s={};return r.forEach((r=>{s[r]=t[r][e]})),s}function ct(t,e=Object.keys(t)){const r=t[e[0]].length,s=new Array(r);return Z(s,((r,i)=>{s[i]=lt(t,i,e)})),s}const ut=t=>({}.toString.call(t).match(/\s(\w+)/)[1].toLowerCase()),dt=(t,e)=>ut(t)===e,mt=(t,e)=>e.includes(ut(t)),pt=t=>dt(t,"string"),gt=t=>dt(t,"object"),ft=t=>Array.isArray(t),yt=t=>dt(t,"number"),xt=t=>Number.isInteger(t),wt=t=>dt(t,"function"),bt=t=>mt(t,["htmlcanvaselement","offscreencanvas"]),Mt=t=>mt(t,["image","htmlimageelement","htmlcanvaselement","offscreencanvas","imagebitmap"]),vt=t=>"arraybuffer"===ut(t.buffer),zt=t=>ft(t)||vt(t);function _t(t,e){return t.constructor===e?t:e.from(t)}function St(t){return"object"===ut(t)&&t.width&&t.height&&t.data}function Ct(t,e="download.png",r=null){e.endsWith(".png")||e.endsWith(".jpeg")||(e+=".png");const s=e.endsWith(".png")?"image/png":"image/jpeg",i="string"===ut(t)?t:t.toDataURL(s,r),n=document.createElement("a");n.download=e,n.href=i,n.click()}async function At(s,i=!0){if(t()&&i||r())return new Promise(((t,e)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>t(r),r.onerror=()=>e(`Could not load image ${s}`),r.src=s}));if(e()||!i){const t=await fetch(s).then((t=>t.blob()));return createImageBitmap(t)}}function Et(s,i,n=!0){if(t()&&n){const t=document.createElement("canvas");return t.width=s,t.height=i,t}return r()?globalThis.createCanvas(s,i):e()||!n?new OffscreenCanvas(s,i):void 0}function Pt(t,e,s=!0,i={}){const n=Et(t,e,s),o=n.getContext("2d",i);if(r()){const t={canvas:n};return Object.setPrototypeOf(t,o),t}return o}function Ot(t,e=!0){const r=Pt(t.width,t.height,e);return r.drawImage(t,0,0),r.canvas}function kt(t,e,r){const s=Ot(t.canvas);t.canvas.width=e,t.canvas.height=r,t.drawImage(s,0,0)}function It(t,e,r){t.width===e&&t.height==r||(t.width=e,t.height=r)}function Tt(t){t.save(),t.resetTransform()}function Rt(t,e,r="center",s="middle"){Object.assign(t,{font:e,textAlign:r,textBaseline:s})}let Xt;function jt(t,e,r,s,i,n=!0){n&&Tt(t),t.fillStyle=i.css||i,t.fillText(e,r,s),n&&t.restore()}function Ft(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)}function Yt(t){const e=Ft(t).data,r=[];return H(e.length,4,(t=>r.push(e.subarray(t,t+4)))),r}function Dt(t,e){const{width:r,height:s}=t.canvas;Tt(t),e&&"transparent"!==e?(e=e.css||e,t.fillStyle=e,t.fillRect(0,0,r,s)):t.clearRect(0,0,r,s),t.restore()}function Nt(t){const{width:e,height:r}=t,s=Pt(e,r);return Lt(s,t),s}function Lt(t,e){Tt(t),t.drawImage(e,0,0,t.canvas.width,t.canvas.height),t.restore()}function Ut(t){const e=document.createElement("style");e.innerHTML=t,document.head.appendChild(e)}function $t(){return window.location.search.substr(1)}function Bt(t=$t()){const e={},r=new URLSearchParams(t);for(const t of r.entries()){let[r,s]=t;(s.match(/^[0-9.]+$/)||s.match(/^[0-9.]+e[0-9]+$/))&&(s=Number(s)),["true","t",""].includes(s)&&(s=!0),["false","f"].includes(s)&&(s=!1),e[r]=s}return e}var Wt=Object.freeze({__proto__:null,inMain:t,inWorker:e,inNode:function(){return void 0!==globalThis.require},inDeno:r,AsyncFunction:function(t,e){return new(0,Object.getPrototypeOf((async function(){})).constructor)(...t,e)},blobToData:function(t,e="dataURL"){e=e[0].toUpperCase()+e.slice(1);const r=["Text","ArrayBuffer","DataURL"];if(!r.includes(e))throw Error("blobToData: data must be one of "+r.toString());const s=new FileReader;return new Promise(((r,i)=>{s.addEventListener("load",(()=>r(s.result))),s.addEventListener("error",(t=>i(t))),s["readAs"+e](t)}))},toDataURL:function(t,e){return t.toDataURL?t.toDataURL(e,e):(e||(e="text/plain;charset=US-ASCII"),`data:${e};base64,${btoa(t)}}`)},blobsEqual:async function(t,e){return await t.text()===await e.text()},pause:s,timeoutLoop:i,waitUntilDone:function(t,e=10){return new Promise((r=>{!function s(){if(t())return r();setTimeout(s,e)}()}))},fetchImageBitmap:async function(t){const e=await fetch(t).then((t=>t.blob()));return await createImageBitmap(e)},skipErrorChecks:function(t){n=t},checkArg:o,checkArgs:function(t,e="number",r="Function"){n||("arguments"===ut(t)&&(t=Array.from(t)),t.forEach((t=>{o(t,e,r)})))},logOnce:h,warn:l,timeit:function(t,e=1e5,r="test"){r=r+"-"+e,console.time(r);for(let r=0;r<e;r++)t(r);console.timeEnd(r)},fps:function(){const t="undefined"==typeof performance?Date:performance,e=t.now();let r=0;function s(){r++;const i=t.now()-e,n=parseFloat((r/(i/1e3)).toFixed(2));Object.assign(s,{fps:n,ms:i,start:e,steps:r})}return s.steps=0,s},pps:function(t,e=""){e&&console.log(e);let r=1,s="";for(;t;){if("function"==typeof t)s=t.constructor.toString();else{const e=Object.keys(t);s=e.length>0?`[${e.join(", ")}]`:`[${t.constructor.name}]`}console.log(`[${r++}]: ${s}`),t=Object.getPrototypeOf(t)}},logAll:function(t){Object.keys(t).forEach((e=>console.log("  ",e,t[e])))},PI:c,randomInt:u,randomInt2:d,randomFloat:m,randomFloat2:p,randomCentered:function(t){return p(-t/2,t/2)},randomNormal:function(t=0,e=1){const[r,s]=[1-Math.random(),Math.random()];return Math.sqrt(-2*Math.log(r))*Math.cos(2*c*s)*e+t},randomSeed:g,precision:f,isPowerOf2:y,nextPowerOf2:t=>Math.pow(2,Math.ceil(Math.log2(t))),mod:x,wrap:w,clamp:b,isBetween:M,lerp:v,lerpScale:z,toDeg:_,toRad:S,degToRad:C,radToDeg:A,degToHeading:t=>E(90-t),headingToDeg:t=>E(90-t),mod360:E,mod2pi:P,modpipi:function(t){return x(t,2*c)-c},mod180180:function(t){return E(t)-180},radToHeading:O,headingToRad:function(t){return E(90-t)*S},radToHeadingAngle:function(t){return-A(t)},headingAngleToRad:function(t){return-C(t)},degreesEqual:k,radsEqual:function(t,e){return P(t)===P(e)},headingsEq:I,subtractRadians:T,subtractDegrees:R,subtractHeadings:X,radiansTowardXY:j,headingTowardXY:function(t,e,r,s){return O(j(t,e,r,s))},degreesTowardXY:function(t,e,r,s){return A(j(t,e,r,s))},inCone:F,sqDistance:Y,distance:D,sqDistance3:N,distance3:L,runModel:async function(e,r=500,s=!0){if(console.log("runModel: model",e),s&&g(),pt(e)&&(e=(await import(e)).default),wt(e)&&(e=new e),await e.startup(),e.setup(),t())await i((()=>{e.step()}),r);else for(let t=0;t<r;t++)e.step();return e},toJSON:U,sampleModel:function(t){const e=U({ticks:t.ticks,model:Object.keys(t),patches:t.patches.length,patch:t.patches.oneOf(),turtles:t.turtles.length,turtle:t.turtles.oneOf(),links:t.links.length,link:t.links.oneOf()});return JSON.parse(e)},identityFcn:$,noopFcn:()=>{},propFcn:B,arraysEqual:W,removeArrayItem:V,arraysToString:q,forLoop:Z,repeat:G,step:H,range:function(t){return G(t,((t,e)=>{e[t]=t}))},grep:function(t,e){return t.reduce(((t,r)=>(e.test(r)&&t.push(r),t)),[])},concatArrays:J,objectToString:function(t,e=2,r=!0){let s=JSON.stringify(t,null,e);return r&&(s=s.replace(/"([^"]+)":/gm,"$1:")),s},objectsEqual:(t,e)=>JSON.stringify(t)===JSON.stringify(e),oneOf:Q,otherOneOf:K,oneKeyOf:tt,oneValOf:et,sortNums:function(t,e=!0){return t.sort(((t,r)=>e?t-r:r-t))},sortObjs:rt,shuffle:st,union:function(t,e){return Array.from(new Set(t.concat(e)))},intersection:function(t,e){const r=new Set(e);return t.filter((t=>r.has(t)))},difference:function(t,e){const r=new Set(e);return t.filter((t=>!r.has(t)))},floatRamp:it,integerRamp:nt,nestedProperty:function(t,e){switch("string"==typeof e&&(e=e.split(".")),e.length){case 1:return t[e[0]];case 2:return t[e[0]][e[1]];case 3:return t[e[0]][e[1]][e[2]];case 4:return t[e[0]][e[1]][e[2]][e[3]];default:return e.reduce(((t,e)=>t[e]),t)}},arrayLast:t=>t[t.length-1],arrayMax:ot,arrayMin:at,arrayExtent:t=>[at(t),ot(t)],arraysDiff:(t,e,r=(t=>t))=>{if(t.length!==e.length)return console.log("lengths differ",t.length,e.length);const s=[];for(let i=0;i<t.length;i++)t[i]!==e[i]&&s.push([r(i),t[i],e[i]]);return s},arrayToMatrix:function(t,e,r){if(t.length!==e*r)throw Error("arrayToMatrix: length !== width * height");const s=[];for(let i=0;i<r;i++){const r=t.slice(i*e,(i+1)*e);s.push(r)}return s},matrixToArray:t=>t.flat(),isOofA:ht,toOofA:function(t,e){const r=t.length,s=Object.keys(e),i={};return s.forEach((t=>{i[t]=new e[t](r)})),Z(t,((t,e)=>{s.forEach((r=>i[r][e]=t[r]))})),i},oofaObject:lt,toAofO:ct,oofaBuffers:function(t){const e=[];return Z(t,(t=>Z(t,(t=>e.push(t.buffer))))),e},typeOf:ut,isType:dt,isOneOfTypes:mt,isString:pt,isObject:gt,isArray:ft,isNumber:yt,isInteger:xt,isFunction:wt,isImage:t=>dt(t,"image"),isCanvas:bt,isImageable:Mt,isTypedArray:vt,isUintArray:t=>/^uint.*array$/.test(ut(t)),isIntArray:t=>/^int.*array$/.test(ut(t)),isFloatArray:t=>/^float.*array$/.test(ut(t)),isArrayLike:zt,isColorLikeArray:t=>zt(t)&&[3,4].includes(t.length)&&t.every((t=>xt(t)&&M(t,0,255)||yt(t)&&M(t,0,1))),isLittleEndian:function(){const t=new Uint32Array([16909060]);return 4===new Uint8ClampedArray(t.buffer)[0]},convertArrayType:_t,isDataSet:St,downloadCanvas:Ct,downloadBlob:function(t,e="download",r=!0){St(t)&&!Array.isArray(t.data)&&(t.data=Array.from(t.data)),vt(t)&&(t=Array.from(t)),(gt(t)||Array.isArray(t))&&(t=r?JSON.stringify(t,null,2):JSON.stringify(t));const s="blob"===ut(t)?t:new Blob([t]),i=URL.createObjectURL(s),n=document.createElement("a");n.download=e,n.href=i,n.click(),URL.revokeObjectURL(i)},imagePromise:At,createCanvas:Et,createCtx:Pt,cloneCanvas:Ot,resizeCtx:kt,setCanvasSize:It,setIdentity:Tt,setTextProperties:Rt,stringMetrics:function(t,e,r="center",s="middle"){Xt||(Xt=Pt(0,0)),Rt(Xt,e,r,s);const i=Xt.measureText(t);return i.height=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent,i},drawText:jt,ctxImageData:Ft,ctxImageColors:Yt,ctxImagePixels:function(t){const e=Ft(t);return new Uint32Array(e.data.buffer)},clearCtx:Dt,imageToCtx:Nt,imageToCanvas:function(t){return Nt(t).canvas},fillCtxWithImage:Lt,setCtxImage:function(t,e){It(t.canvas,e.width,e.height),Lt(t,e)},toWindow:function(t){Object.assign(window,t),console.log("toWindow:",Object.keys(t).join(", "))},dump:function(t=window.model){const{patches:e,turtles:r,links:s}=t;Object.assign(window,{ps:e,ts:r,ls:s}),window.p=e.length>0?e.oneOf():{},window.t=r.length>0?r.oneOf():{},window.l=s.length>0?s.oneOf():{},console.log("debug: ps, ts, ls, p, t, l dumped to window")},addCssLink:function(t){const e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href",t),document.head.appendChild(e)},fetchCssStyle:async function(t){const e=await fetch(t);if(!e.ok)throw Error(`fetchCssStyle: Not found: ${t}`);const r=await e.text();return Ut(r),r},addCssStyle:Ut,getQueryString:$t,parseQueryString:Bt,RESTapi:function(t){return Object.assign(t,Bt())},printToPage:function(t,e=document.body){"object"==typeof t&&(t=JSON.stringify(t,null,2)),t="<pre>"+t+"</pre>","string"==typeof e&&(e=document.getElementById(e)),e.style.fontFamily="monospace",e.innerHTML+=t},getEventXY:function(t,e){const r=t.getBoundingClientRect();return[e.clientX-r.left,e.clientY-r.top]}});async function Vt(t){const e=ut(t);switch(e){case"string":t=await At(t);case"htmlimageelement":return Nt(t);case"htmlcanvaselement":case"offscreencanvas":return t.getContext("2d");case"canvasrenderingcontext2d":return t;default:throw Error("toContext: bad img type: "+e)}}const qt=[{shift:5,msgMask:7,dataMask:248},{shift:3,msgMask:3,dataMask:252},{shift:0,msgMask:7,dataMask:248}];function Zt(t){for(let e=3;e<t.length;e+=4)if(254===t[e])return(e-3)/4;throw Error(`decode: no message terminator in image data, length = ${t.length}`)}var Gt=Object.freeze({__proto__:null,stegMsgSize:Zt,encode:async function(t,e){const r=await Vt(t),{width:s,height:i}=r.canvas;!function(t,e,r){const s=e*r;if(s<t.length)throw Error(`encode: image size < msg.length: ${s} ${t.length}`)}(e,s,i);const n=function(t){const e=ut(t);switch(e){case"number":t=String.fromCharCode(t);case"string":return(new TextEncoder).encode(t);case"uint8array":case"uint8clampedarray":return t;default:throw Error("toUint8Array: bad msg type: "+e)}}(e);console.log("msg buffer",n);const o=r.getImageData(0,0,s,i),a=o.data;let h;return console.log("imgageData.data",a),n.forEach(((t,e)=>{const[r,s,i]=function(t){return[t>>qt[0].shift,t>>qt[1].shift&qt[1].msgMask,t&qt[2].msgMask]}(t);h=4*e,a[h]=(a[h++]&qt[0].dataMask)+r,a[h]=(a[h++]&qt[1].dataMask)+s,a[h]=(a[h++]&qt[2].dataMask)+i,a[h]=255})),a[h+4]=254,console.log("encoded imgageData.data",a),r.putImageData(o,0,0),console.log("msg length",e.length),console.log("encode: embedded msg size",Zt(a)),r},decode:async function(t,e=!1){const r=await Vt(t),{width:s,height:i}=r.canvas,n=r.getImageData(0,0,s,i).data,o=Zt(n);console.log("decode: embedded msg size",o);const a=new Uint8Array(o);return a.forEach(((t,e)=>{let r=4*e;const s=(qt[0].msgMask&n[r++])<<qt[0].shift,i=(qt[1].msgMask&n[r++])<<qt[1].shift,o=(qt[2].msgMask&n[r++])<<qt[2].shift;a[e]=s+i+o})),console.log("decode msgArray",a),e?a:(new TextDecoder).decode(a)}}),Ht={centimeters:637100880,centimetres:637100880,degrees:6371008.8/111325,feet:20902260.511392,inches:6371008.8*39.37,kilometers:6371.0088,kilometres:6371.0088,meters:6371008.8,metres:6371008.8,miles:3958.761333810546,millimeters:6371008800,millimetres:6371008800,nauticalmiles:6371008.8/1852,radians:1,yards:6371008.8*1.0936},Jt={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,hectares:1e-4,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,millimeters:1e6,millimetres:1e6,yards:1.195990046};function Qt(t,e,r){void 0===r&&(r={});var s={type:"Feature"};return(0===r.id||r.id)&&(s.id=r.id),r.bbox&&(s.bbox=r.bbox),s.properties=e||{},s.geometry=t,s}function Kt(t,e,r){if(void 0===r&&(r={}),!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!he(t[0])||!he(t[1]))throw new Error("coordinates must contain numbers");return Qt({type:"Point",coordinates:t},e,r)}function te(t,e,r){void 0===r&&(r={});for(var s=0,i=t;s<i.length;s++){var n=i[s];if(n.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var o=0;o<n[n.length-1].length;o++)if(n[n.length-1][o]!==n[0][o])throw new Error("First and last Position are not equivalent.")}return Qt({type:"Polygon",coordinates:t},e,r)}function ee(t,e,r){if(void 0===r&&(r={}),t.length<2)throw new Error("coordinates must be an array of two or more positions");return Qt({type:"LineString",coordinates:t},e,r)}function re(t,e){void 0===e&&(e={});var r={type:"FeatureCollection"};return e.id&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.features=t,r}function se(t,e,r){return void 0===r&&(r={}),Qt({type:"MultiLineString",coordinates:t},e,r)}function ie(t,e,r){return void 0===r&&(r={}),Qt({type:"MultiPoint",coordinates:t},e,r)}function ne(t,e,r){return void 0===r&&(r={}),Qt({type:"MultiPolygon",coordinates:t},e,r)}function oe(t,e){void 0===e&&(e="kilometers");var r=Ht[e];if(!r)throw new Error(e+" units is invalid");return t*r}function ae(t,e){void 0===e&&(e="kilometers");var r=Ht[e];if(!r)throw new Error(e+" units is invalid");return t/r}function he(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function le(t){return!!t&&t.constructor===Object}function ce(t,e,r){if(null!==t)for(var s,i,n,o,a,h,l,c,u=0,d=0,m=t.type,p="FeatureCollection"===m,g="Feature"===m,f=p?t.features.length:1,y=0;y<f;y++){a=(c=!!(l=p?t.features[y].geometry:g?t.geometry:t)&&"GeometryCollection"===l.type)?l.geometries.length:1;for(var x=0;x<a;x++){var w=0,b=0;if(null!==(o=c?l.geometries[x]:l)){h=o.coordinates;var M=o.type;switch(u=!r||"Polygon"!==M&&"MultiPolygon"!==M?0:1,M){case null:break;case"Point":if(!1===e(h,d,y,w,b))return!1;d++,w++;break;case"LineString":case"MultiPoint":for(s=0;s<h.length;s++){if(!1===e(h[s],d,y,w,b))return!1;d++,"MultiPoint"===M&&w++}"LineString"===M&&w++;break;case"Polygon":case"MultiLineString":for(s=0;s<h.length;s++){for(i=0;i<h[s].length-u;i++){if(!1===e(h[s][i],d,y,w,b))return!1;d++}"MultiLineString"===M&&w++,"Polygon"===M&&b++}"Polygon"===M&&w++;break;case"MultiPolygon":for(s=0;s<h.length;s++){for(b=0,i=0;i<h[s].length;i++){for(n=0;n<h[s][i].length-u;n++){if(!1===e(h[s][i][n],d,y,w,b))return!1;d++}b++}w++}break;case"GeometryCollection":for(s=0;s<o.geometries.length;s++)if(!1===ce(o.geometries[s],e,r))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function ue(t,e){var r;switch(t.type){case"FeatureCollection":for(r=0;r<t.features.length&&!1!==e(t.features[r].properties,r);r++);break;case"Feature":e(t.properties,0)}}function de(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var r=0;r<t.features.length&&!1!==e(t.features[r],r);r++);}function me(t,e){var r,s,i,n,o,a,h,l,c,u,d=0,m="FeatureCollection"===t.type,p="Feature"===t.type,g=m?t.features.length:1;for(r=0;r<g;r++){for(a=m?t.features[r].geometry:p?t.geometry:t,l=m?t.features[r].properties:p?t.properties:{},c=m?t.features[r].bbox:p?t.bbox:void 0,u=m?t.features[r].id:p?t.id:void 0,o=(h=!!a&&"GeometryCollection"===a.type)?a.geometries.length:1,i=0;i<o;i++)if(null!==(n=h?a.geometries[i]:a))switch(n.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===e(n,d,l,c,u))return!1;break;case"GeometryCollection":for(s=0;s<n.geometries.length;s++)if(!1===e(n.geometries[s],d,l,c,u))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===e(null,d,l,c,u))return!1;d++}}function pe(t,e){me(t,(function(t,r,s,i,n){var o,a=null===t?null:t.type;switch(a){case null:case"Point":case"LineString":case"Polygon":return!1!==e(Qt(t,s,{bbox:i,id:n}),r,0)&&void 0}switch(a){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}for(var h=0;h<t.coordinates.length;h++){var l=t.coordinates[h];if(!1===e(Qt({type:o,coordinates:l},s),r,h))return!1}}))}function ge(t,e){pe(t,(function(t,r,s){var i=0;if(t.geometry){var n=t.geometry.type;if("Point"!==n&&"MultiPoint"!==n){var o,a=0,h=0,l=0;return!1!==ce(t,(function(n,c,u,d,m){if(void 0===o||r>a||d>h||m>l)return o=n,a=r,h=d,l=m,void(i=0);var p=ee([o,n],t.properties);if(!1===e(p,r,s,m,i))return!1;i++,o=n}))&&void 0}}}))}function fe(t,e){if(!t)throw new Error("geojson is required");pe(t,(function(t,r,s){if(null!==t.geometry){var i=t.geometry.type,n=t.geometry.coordinates;switch(i){case"LineString":if(!1===e(t,r,s,0,0))return!1;break;case"Polygon":for(var o=0;o<n.length;o++)if(!1===e(ee(n[o],t.properties),r,s,o))return!1}}}))}function ye(t){var e=[1/0,1/0,-1/0,-1/0];return ce(t,(function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])})),e}function xe(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if("Feature"===t.type&&null!==t.geometry&&"Point"===t.geometry.type)return t.geometry.coordinates;if("Point"===t.type)return t.coordinates}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function we(t){return"Feature"===t.type?t.geometry:t}function be(t,e,r){var s=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var i=0,n=e.length-1;i<e.length;n=i++){var o=e[i][0],a=e[i][1],h=e[n][0],l=e[n][1];if(t[1]*(o-h)+a*(h-t[0])+l*(t[0]-o)==0&&(o-t[0])*(h-t[0])<=0&&(a-t[1])*(l-t[1])<=0)return!r;a>t[1]!=l>t[1]&&t[0]<(h-o)*(t[1]-a)/(l-a)+o&&(s=!s)}return s}ye.default=ye;var Me=Object.freeze({__proto__:null,bbox:ye,bboxPolygon:function(t,e){void 0===e&&(e={});var r=Number(t[0]),s=Number(t[1]),i=Number(t[2]),n=Number(t[3]);if(6===t.length)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var o=[r,s];return te([[o,[i,s],[i,n],[r,n],o]],e.properties,{bbox:t,id:e.id})},bearingToAzimuth:function(t){var e=t%360;return e<0&&(e+=360),e},booleanPointInPolygon:function(t,e,r){if(void 0===r&&(r={}),!t)throw new Error("point is required");if(!e)throw new Error("polygon is required");var s=xe(t),i=we(e),n=i.type,o=e.bbox,a=i.coordinates;if(o&&!1===function(t,e){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]>=t[0]&&e[3]>=t[1]}(s,o))return!1;"Polygon"===n&&(a=[a]);for(var h=!1,l=0;l<a.length&&!h;l++)if(be(s,a[l][0],r.ignoreBoundary)){for(var c=!1,u=1;u<a[l].length&&!c;)be(s,a[l][u],!r.ignoreBoundary)&&(c=!0),u++;c||(h=!0)}return h},collectionOf:function(t,e,r){if(!t)throw new Error("No featureCollection passed");if(!r)throw new Error(".collectionOf() requires a name");if(!t||"FeatureCollection"!==t.type)throw new Error("Invalid input to "+r+", FeatureCollection required");for(var s=0,i=t.features;s<i.length;s++){var n=i[s];if(!n||"Feature"!==n.type||!n.geometry)throw new Error("Invalid input to "+r+", Feature with geometry required");if(!n.geometry||n.geometry.type!==e)throw new Error("Invalid input to "+r+": must be a "+e+", given "+n.geometry.type)}},containsNumber:function t(e){if(e.length>1&&he(e[0])&&he(e[1]))return!0;if(Array.isArray(e[0])&&e[0].length)return t(e[0]);throw new Error("coordinates must only contain numbers")},convertArea:function(t,e,r){if(void 0===e&&(e="meters"),void 0===r&&(r="kilometers"),!(t>=0))throw new Error("area must be a positive number");var s=Jt[e];if(!s)throw new Error("invalid original units");var i=Jt[r];if(!i)throw new Error("invalid final units");return t/s*i},convertLength:function(t,e,r){if(void 0===e&&(e="kilometers"),void 0===r&&(r="kilometers"),!(t>=0))throw new Error("length must be a positive number");return oe(ae(t,e),r)},coordAll:function(t){var e=[];return ce(t,(function(t){e.push(t)})),e},coordEach:ce,coordReduce:function(t,e,r,s){var i=r;return ce(t,(function(t,s,n,o,a){i=0===s&&void 0===r?t:e(i,t,s,n,o,a)}),s),i},feature:Qt,featureCollection:re,featureEach:de,featureOf:function(t,e,r){if(!t)throw new Error("No feature passed");if(!r)throw new Error(".featureOf() requires a name");if(!t||"Feature"!==t.type||!t.geometry)throw new Error("Invalid input to "+r+", Feature with geometry required");if(!t.geometry||t.geometry.type!==e)throw new Error("Invalid input to "+r+": must be a "+e+", given "+t.geometry.type)},featureReduce:function(t,e,r){var s=r;return de(t,(function(t,i){s=0===i&&void 0===r?t:e(s,t,i)})),s},findPoint:function(t,e){if(!le(e=e||{}))throw new Error("options is invalid");var r,s=e.featureIndex||0,i=e.multiFeatureIndex||0,n=e.geometryIndex||0,o=e.coordIndex||0,a=e.properties;switch(t.type){case"FeatureCollection":s<0&&(s=t.features.length+s),a=a||t.features[s].properties,r=t.features[s].geometry;break;case"Feature":a=a||t.properties,r=t.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=t;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var h=r.coordinates;switch(r.type){case"Point":return Kt(h,a,e);case"MultiPoint":return i<0&&(i=h.length+i),Kt(h[i],a,e);case"LineString":return o<0&&(o=h.length+o),Kt(h[o],a,e);case"Polygon":return n<0&&(n=h.length+n),o<0&&(o=h[n].length+o),Kt(h[n][o],a,e);case"MultiLineString":return i<0&&(i=h.length+i),o<0&&(o=h[i].length+o),Kt(h[i][o],a,e);case"MultiPolygon":return i<0&&(i=h.length+i),n<0&&(n=h[i].length+n),o<0&&(o=h[i][n].length-o),Kt(h[i][n][o],a,e)}throw new Error("geojson is invalid")},findSegment:function(t,e){if(!le(e=e||{}))throw new Error("options is invalid");var r,s=e.featureIndex||0,i=e.multiFeatureIndex||0,n=e.geometryIndex||0,o=e.segmentIndex||0,a=e.properties;switch(t.type){case"FeatureCollection":s<0&&(s=t.features.length+s),a=a||t.features[s].properties,r=t.features[s].geometry;break;case"Feature":a=a||t.properties,r=t.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=t;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var h=r.coordinates;switch(r.type){case"Point":case"MultiPoint":return null;case"LineString":return o<0&&(o=h.length+o-1),ee([h[o],h[o+1]],a,e);case"Polygon":return n<0&&(n=h.length+n),o<0&&(o=h[n].length+o-1),ee([h[n][o],h[n][o+1]],a,e);case"MultiLineString":return i<0&&(i=h.length+i),o<0&&(o=h[i].length+o-1),ee([h[i][o],h[i][o+1]],a,e);case"MultiPolygon":return i<0&&(i=h.length+i),n<0&&(n=h[i].length+n),o<0&&(o=h[i][n].length-o-1),ee([h[i][n][o],h[i][n][o+1]],a,e)}throw new Error("geojson is invalid")},flattenEach:pe,flattenReduce:function(t,e,r){var s=r;return pe(t,(function(t,i,n){s=0===i&&0===n&&void 0===r?t:e(s,t,i,n)})),s},geojsonType:function(t,e,r){if(!e||!r)throw new Error("type and name required");if(!t||t.type!==e)throw new Error("Invalid input to "+r+": must be a "+e+", given "+t.type)},geomEach:me,geomReduce:function(t,e,r){var s=r;return me(t,(function(t,i,n,o,a){s=0===i&&void 0===r?t:e(s,t,i,n,o,a)})),s},geometry:function(t,e,r){switch(t){case"Point":return Kt(e).geometry;case"LineString":return ee(e).geometry;case"Polygon":return te(e).geometry;case"MultiPoint":return ie(e).geometry;case"MultiLineString":return se(e).geometry;case"MultiPolygon":return ne(e).geometry;default:throw new Error(t+" is invalid")}},geometryCollection:function(t,e,r){return void 0===r&&(r={}),Qt({type:"GeometryCollection",geometries:t},e,r)},getCoord:xe,getCoords:function(t){if(Array.isArray(t))return t;if("Feature"===t.type){if(null!==t.geometry)return t.geometry.coordinates}else if(t.coordinates)return t.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")},getGeom:we,getType:function(t,e){return"FeatureCollection"===t.type?"FeatureCollection":"GeometryCollection"===t.type?"GeometryCollection":"Feature"===t.type&&null!==t.geometry?t.geometry.type:t.type},lengthToDegrees:function(t,e){return function(t){return t%(2*Math.PI)*180/Math.PI}(ae(t,e))},lengthToRadians:ae,lineEach:fe,lineReduce:function(t,e,r){var s=r;return fe(t,(function(t,i,n,o){s=0===i&&void 0===r?t:e(s,t,i,n,o)})),s},lineString:ee,lineStrings:function(t,e,r){return void 0===r&&(r={}),re(t.map((function(t){return ee(t,e)})),r)},multiLineString:se,multiPoint:ie,multiPolygon:ne,point:Kt,points:function(t,e,r){return void 0===r&&(r={}),re(t.map((function(t){return Kt(t,e)})),r)},polygon:te,polygons:function(t,e,r){return void 0===r&&(r={}),re(t.map((function(t){return te(t,e)})),r)},propEach:ue,propReduce:function(t,e,r){var s=r;return ue(t,(function(t,i){s=0===i&&void 0===r?t:e(s,t,i)})),s},radiansToLength:oe,segmentEach:ge,segmentReduce:function(t,e,r){var s=r,i=!1;return ge(t,(function(t,n,o,a,h){s=!1===i&&void 0===r?t:e(s,t,n,o,a,h),i=!0})),s}});class ve extends Array{static get[Symbol.species](){return ve}static fromArray(t){return Object.setPrototypeOf(t,ve.prototype)}constructor(...t){super(...t)}toArray(){return Object.setPrototypeOf(this,Array.prototype),this}isEmpty(){return 0===this.length}first(){return this[0]}last(){return this[this.length-1]}atIndex(t){if(0===this.length)return;return this[x(t,this.length)]}all(t){return this.every(t)}props(t,e=ve){const r=new e(this.length);for(let e=0;e<this.length;e++)r[e]=this[e][t];return r}typedSample(t){const e={};return Z(t,((t,r)=>{e[r]=this.props(r,t)})),e}uniq(){return ve.from(new Set(this))}forLoop(t){for(let e=0,r=this.length;e<r;e++)t(this[e],e,this);return this}ask(t){const e=this.length;for(let r=0;r<Math.min(e,this.length);r++)t(this[r],r,this);if(e!=this.length){l(`AgentArray.ask array mutation: ${this.name||this.constructor.name}: ${this.length<e?"decreasing":"increasing"}`)}}with(t){return this.filter(t)}other(t){return this.filter((e=>e!==t))}getValues(t){const e=new ve;return pt(t)?this.forLoop((r=>e.push(r[t]))):this.forLoop((r=>e.push(t(r)))),e}count(t){return this.reduce(((e,r)=>e+(t(r)?1:0)),0)}sum(t){return this.reduce(((e,r)=>e+(t?r[t]:r)),0)}avg(t){return this.sum(t)/this.length}min(t){return this.reduce(((e,r)=>Math.min(e,t?r[t]:r)),1/0)}max(t){return this.reduce(((e,r)=>Math.max(e,t?r[t]:r)),-1/0)}extent(t){return[this.min(t),this.max(t)]}histogram(t,e=10,r=this.min(t),s=this.max(t)){const i=(s-r)/e,n=new ve(e);return n.fill(0),this.ask((o=>{const a=t?o[t]:o;if(a<r||a>s)l(`histogram bounds error: ${a}: ${r}-${s}`);else{let t=Math.floor((a-r)/i);t===e&&t--,n[t]++}})),n.parameters={key:t,bins:e,min:r,max:s,binSize:i,arraySize:this.length},n}clone(){return this.slice(0)}shuffle(){return st(this)}sortBy(t,e=!0){return rt(this,t,e),this}remove(t,e){const r=this.agentIndex(t,e);return-1!==r?this.splice(r,1):l(`remove: ${t} not in AgentArray`),this}insert(t,e){const r=this.sortedIndex(t,e);if(this[r]===t)throw Error("insert: item already in AgentArray");this.splice(r,0,t)}sortedIndex(t,e=$){pt(e)&&(e=B(e));const r=e(t);let s=0,i=this.length;for(;s<i;){const t=s+i>>>1;e(this[t])<r?s=t+1:i=t}return s}agentIndex(t,e){if(!e)return this.indexOf(t);const r=this.sortedIndex(t,e);return this[r]===t?r:-1}contains(t,e){return this.agentIndex(t,e)>=0}oneOf(){return Q(this)}otherOneOf(t){return K(this,t)}otherNOf(t,e){if(this.length<t)throw Error("AgentArray: otherNOf: length < N");return this.clone().remove(e).shuffle().slice(0,t)}minOrMaxOf(t,e,r=!1){if(this.isEmpty())throw Error("min/max OneOf: empty array");"string"==typeof e&&(e=B(e));let s=null,i=t?1/0:-1/0;for(let r=0;r<this.length;r++){const n=this[r],o=e(n);(t&&o<i||!t&&o>i)&&([s,i]=[n,o])}return r?[s,i]:s}minOneOf(t){return this.minOrMaxOf(!0,t)}maxOneOf(t){return this.minOrMaxOf(!1,t)}minValOf(t){return this.minOrMaxOf(!0,t,!0)}maxValOf(t){return this.minOrMaxOf(!1,t,!0)}nOf(t){if(t>this.length)throw Error("nOf: n larger than AgentArray");if(t===this.length)return this;const e=new ve;for(;e.length<t;){const t=this.oneOf();t in e||e.push(t)}return e}minOrMaxNOf(t,e,r){if(e>this.length)throw Error("min/max nOf: n larger than AgentArray");const s=this.clone().sortBy(r);return t?s.slice(0,e):s.slice(s.length-e)}minNOf(t,e){return this.minOrMaxNOf(!0,t,e)}maxNOf(t,e){return this.minOrMaxNOf(!1,t,e)}}class ze extends ve{constructor(t,...e){if(!t)throw Error("AgentList requires model");super(...e),this.model=t}inRect(t,e,r=e,s=!1){const i=new ze(this.model),n=t.x-e,o=t.x+e,a=t.y-r,h=t.y+r;return this.ask((e=>{n<=e.x&&e.x<=o&&a<=e.y&&e.y<=h&&(s||t!==e)&&i.push(e)})),i}inRadius(t,e,r=!1){const s=new ze(this.model),i=e*e,n=Y;return this.ask((e=>{n(t.x,t.y,e.x,e.y)<=i&&(r||t!==e)&&s.push(e)})),s}inCone(t,e,r,s,i=!1){s=this.model.toRads(s),r=this.model.toAngleRads(r);const n=new ze(this.model);return this.ask((o=>{F(o.x,o.y,e,r,s,t.x,t.y)&&(i||t!==o)&&n.push(o)})),n}}class _e extends ve{model;name;baseSet;AgentClass;static get[Symbol.species](){return ve}constructor(t,e,r,s=null){super(),s=s||this,Object.assign(this,{model:t,name:r,baseSet:s,AgentClass:e}),this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(s)),this.baseSet.breeds[r]=this),this.ownVariables=[],this.agentProto=new e(this),this.protoMixin(this.agentProto,e)}protoMixin(t,e){Object.assign(t,{agentSet:this,model:this.model}),t[this.baseSet.name]=this.baseSet,e.prototype.setBreed||(Object.assign(e.prototype,{setBreed(t){t.setBreed(this)},getBreed(){return this.agentSet},isBreed(t){return this.agentSet===t}}),Object.defineProperty(e.prototype,"breed",{get:function(){return this.agentSet}}))}newBreed(t){return new _e(this.model,this.AgentClass,t,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(t){return this.filter((e=>e.agentSet===t))}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(t){return t=t||Object.create(this.agentProto),this.isBreedSet()?this.baseSet.addAgent(t):(t.id=this.ID++,t.agentConstructor&&t.agentConstructor()),this.push(t),t}clear(){for(;!this.isEmpty();)this.last().die()}removeAgent(t){return-1!=t.id&&(this.isBreedSet()&&this.baseSet.remove(t,"id"),this.remove(t,"id")),this}setDefault(t,e){return this.agentProto[t]=e,this}getDefault(t){return this.agentProto[t]}setBreed(t){if(t.agentSet===this)return;t.agentSet.isBreedSet()&&t.agentSet.remove(t,"id"),this.isBreedSet()&&this.insert(t,"id");const e=t.agentSet.ownVariables;for(const r of e)this.ownVariables.includes(r)||delete t[r];for(const r of this.ownVariables)e.includes(r)||(t[r]=0);return Object.setPrototypeOf(t,this.agentProto)}ask(t){if(0===this.length)return;const e=this.last().id;for(let r=0;r<this.length&&this[r].id<=e;r++)t(this[r],r,this)}askSet(t){0!==this.length&&("patches"===this.name?super.forLoop(t):this.isBaseSet()?this.baseSetAsk(t):this.isBreedSet()&&this.cloneAsk(t))}baseSetAsk(t){if(0===this.length)return;const e=this.last().id;for(let r=0;r<this.length;r++){const s=this[r],i=s.id;if(i>e)break;if(t(s,r,this),r>=this.length)break;if(this[r].id>i)for(;r>=0&&this[r].id>i;)r--}}cloneAsk(t){const e=this.clone();for(let r=0;r<e.length;r++){const s=e[r];s.breed==this&&s.id>0&&t(s,r,e)}}}class Se{width;height;data;static emptyDataSet(t,e,r=Array){return new Se(t,e,new r(t*e))}constructor(t,e,r){if(r.length!==t*e)throw Error(`new DataSet length: ${r.length} !== ${t} * ${e}`);Object.assign(this,{width:t,height:e,data:r})}checkXY(t,e){if(!this.inBounds(t,e))throw Error(`DataSet: x,y out of range: ${t}, ${e}`)}inBounds(t,e){return M(t,0,this.width-1)&&M(e,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(t,e){return t+e*this.width}toXY(t){return[t%this.width,Math.floor(t/this.width)]}getXY(t,e){return this.data[this.toIndex(t,e)]}setXY(t,e,r){this.data[this.toIndex(t,e)]=r}sample(t,e,r=!0){return this.checkXY(t,e),r?this.nearest(t,e):this.bilinear(t,e)}nearest(t,e){return this.getXY(Math.round(t),Math.round(e))}bilinear(t,e){const r=Math.floor(t),s=Math.floor(e),i=this.toIndex(r,s),n=this.width,o=t-r,a=e-s,h=1-o,l=1-a;return this.data[i]*h*l+(this.data[i+1]||0)*o*l+(this.data[i+n]||0)*h*a+(this.data[i+1+n]||0)*o*a}clone(){return new Se(this.width,this.height,this.data.slice(0))}emptyDataSet(t,e,r=this.dataType()){return Se.emptyDataSet(t,e,r)}emptyArray(t){return new(this.type())(t)}resample(t,e,r=!0,s=Array){if(t===this.width&&e===this.height)return this.clone();const i=Se.emptyDataSet(t,e,s);for(let s=0;s<e;s++)for(let n=0;n<t;n++)i.setXY(n,s,this.sample(n*(this.width-1)/(t-1),s*(this.height-1)/(e-1),r));return i}scale(t,e){const r=this.min(),s=(e-t)/(this.max()-r),i=t-s*r;return this.map((t=>s*t+i))}subset(t,e,r,s){if(t+r>this.width||e+s>this.height)throw console.log("subset: x+width",t+r,"this.width",this.width),console.log("subset: y+height",e+s,"this.height",this.height),Error("DataSet.subSet: params out of range");const i=this.emptyDataSet(r,s);for(let n=0;n<r;n++)for(let r=0;r<s;r++)i.setXY(n,r,this.getXY(n+t,r+e));return i}crop(t,e,r,s){if(void 0===e)var{top:t,bottom:e,left:r,right:s}=t;const i=this.width-r-s,n=this.height-t-e;return this.subset(r,t,i,n)}map(t){return new Se(this.width,this.height,this.data.map(t))}col(t){const[e,r,s]=[this.width,this.height,this.data];if(t>=e)throw Error(`col: x out of range width: ${e} x: ${t}`);const i=this.emptyArray(r);for(let n=0;n<r;n++)i[n]=s[t+n*e];return i}row(t){const[e,r]=[this.width,this.height];if(t>=r)throw Error(`row: y out of range height: ${r} x: ${t}`);return this.data.slice(t*e,(t+1)*e)}convertType(t){this.data=_t(this.data,t)}concatEast(t){const[e,r]=[this.width,this.height],[s,i]=[t.width,t.height];if(r!==i)throw Error(`concatEast: heights not equal ${r}, ${i}`);const n=this.emptyDataSet(e+s,r);for(let t=0;t<e;t++)for(let e=0;e<r;e++)n.setXY(t,e,this.getXY(t,e));for(let r=0;r<s;r++)for(let s=0;s<i;s++)n.setXY(r+e,s,t.getXY(r,s));return n}concatSouth(t){const[e,r,s]=[this.width,this.height,this.data];if(e!==t.width)throw Error(`concatSouth: widths not equal ${e}, ${t.width}`);const i=J(s,t.data);return new Se(e,r+t.height,i)}transformCoords(t,e,r,s,i,n){return[(t-r)*(this.width-1)/i,(s-e)*(this.height-1)/n]}coordSample(t,e,r,s,i,n,o=!0){const[a,h]=this.transformCoords(t,e,r,s,i,n);return this.sample(a,h,o)}neighborhood(t,e,r=[]){r.length=0;const s=0===t||t===this.width-1||0===e||e===this.height-1;for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++){let o=t+n,a=e+i;s&&(o=b(o,0,this.width-1),a=b(a,0,this.height-1)),r.push(this.data[this.toIndex(o,a)])}return r}convolve(t,e=1,r=!1){const[s,i,n,o]=r?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],a=this.emptyDataSet(o,n),h=a.data;let l=0;for(let r=i;r<n;r++)for(let i=s;i<o;i++){const s=this.neighborhood(i,r);let n=0;for(let e=0;e<t.length;e++)n+=t[e]*s[e];h[l++]=n*e}return a}dzdx(t=2,e=1/8){return this.convolve([-1,0,1,-t,0,t,-1,0,1],e)}dzdy(t=2,e=1/8){return this.convolve([1,t,1,0,0,0,-1,-t,-1],e)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(t=.0625){return this.convolve([1,2,1,2,4,2,1,2,1],t)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(t=1,e=!0){const r=this.dzdx(),s=this.dzdy();let[i,n]=[[],[]];const[o,a]=[r.height,r.width];for(let h=0;h<o;h++)for(let o=0;o<a;o++){const[a,l]=[r.getXY(o,h),s.getXY(o,h)];n.push(Math.atan(D(0,0,a,l))/t);let c=Math.atan2(-l,-a);e&&c<0&&(c+=2*Math.PI),i.push(c)}return n=new Se(a,o,n),i=new Se(a,o,i),{slope:n,aspect:i,dzdx:r,dzdy:s}}max(){return this.data.reduce(((t,e)=>Math.max(t,e)))}min(){return this.data.reduce(((t,e)=>Math.min(t,e)))}extent(){return[this.min(),this.max()]}sum(){return this.data.reduce(((t,e)=>t+e))}normalize(t=0,e=1,r=!1){const[s,i]=this.extent(),n=1/(i-s);let o=this.data.map((r=>v(t,e,n*(r-s))));return r&&(o=o.map((t=>Math.round(t)))),new Se(this.width,this.height,o)}equals(t){return this.width===t.width&&this.height===t.height&&W(this.data,t.data)}}class Ce{hidden=!1;end0=null;end1=null;width=1;agentSet;model;name;init(t,e){this.end0=t,this.end1=e,t.links.push(this),e.links.push(this)}die(){-1!==this.id&&(this.agentSet.removeAgent(this),V(this.end0.links,this),V(this.end1.links,this),this.id=-1)}isDead(){return-1===this.id}bothEnds(){return ve.fromArray([this.end0,this.end1])}length(){return this.end0.distance(this.end1)}get heading(){const{x0:t,x1:e,y0:r,y1:s}=this,i=Math.atan2(s-r,e-t);return this.model.fromRads(i)}otherEnd(t){if(t===this.end0)return this.end1;if(t===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${t}`)}distanceXY(t,e){return this.bothEnds().map((r=>r.distanceXY(t,e))).sum()-this.length()}get x0(){return this.end0.x}get y0(){return this.end0.y}get z0(){return this.end0.z?this.end0.z:0}get x1(){return this.end1.x}get y1(){return this.end1.y}get z1(){return this.end1.z?this.end1.z:0}}class Ae extends _e{createOne(t,e,r=(t=>{})){const s=this.addAgent();return s.init(t,e),r(s),s}create(t,e,r=(t=>{})){return Array.isArray(e)||(e=[e]),e.map((e=>this.createOne(t,e,r)))}}class Ee{maxX=16;minX=-16;maxY=16;minY=-16;maxZ=16;minZ=-16;static defaultOptions(t=16,e=t,r=Math.max(t,e)){return{minX:-t,maxX:t,minY:-e,maxY:e,minZ:-r,maxZ:r}}static defaultWorld(t=16,e=t,r=t){return new Ee(Ee.defaultOptions(t,e,r))}constructor(t={}){Object.assign(this,t),this.setWorld()}setWorld(){let{minX:t,maxX:e,minY:r,maxY:s,minZ:i,maxZ:n}=this;Z({minX:t,maxX:e,minY:r,maxY:s,minZ:i,maxZ:n},((t,e)=>{if(!Number.isInteger(t))throw Error(`World: ${e}:${t} must be an integer`)})),this.numX=this.width=e-t+1,this.numY=this.height=s-r+1,this.numZ=this.depth=n-i+1,this.minXcor=t-.5,this.maxXcor=e+.5,this.minYcor=r-.5,this.maxYcor=s+.5,this.minZcor=i-.5,this.maxZcor=n+.5,this.centerX=(t+e)/2,this.centerY=(r+s)/2,this.centerZ=(i+n)/2,this.numPatches=this.numX*this.numY}getOptions(){const{minX:t,minY:e,minZ:r,maxX:s,maxY:i,maxZ:n}=this;return{minX:t,minY:e,minZ:r,maxX:s,maxY:i,maxZ:n}}randomPoint(){return[p(this.minXcor,this.maxXcor),p(this.minYcor,this.maxYcor)]}random3DPoint(){return[p(this.minXcor,this.maxXcor),p(this.minYcor,this.maxYcor),p(this.minZcor,this.maxZcor)]}randomPatchPoint(){return[d(this.minX,this.maxX),d(this.minY,this.maxY)]}isOnWorld(t,e,r=this.centerZ){return this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=e&&e<=this.maxYcor&&this.minZcor<=r&&r<=this.maxZcor}bboxTransform(t,e,r,s){return new Pe(t,e,r,s,this)}getWorldSize(t=1){return[this.numX*t,this.numY*t]}setEuclideanTransform(t,e){this.setCanvasSize(t.canvas,e),t.restore(),t.save(),t.scale(e,-e),t.translate(-this.minXcor,-this.maxYcor)}patchSize(t){const{numX:e,numY:r}=this,{clientWidth:s,clientHeight:i}=t,n=s/e,o=i/r;if(n!==o)throw Error(`World patchSize: x/y sizes differ ${n}, ${o}`);return n}setCanvasSize(t,e){const[r,s]=this.getWorldSize(e);It(t,r,s)}pixelXYtoPatchXY(t,e,r){return[this.minXcor+t/r,this.maxYcor-e/r]}patchXYtoPixelXY(t,e,r){return[(t-this.minXcor)*r,(this.maxYcor-e)*r]}xyToPatchIndex(t,e){if(!this.isOnWorld(t,e))return;const{minX:r,maxX:s,maxY:i,numX:n,maxXcor:o,maxYcor:a}=this;return(t=t===o?s:Math.round(t))-r+n*(i-(e=e===a?i:Math.round(e)))}}class Pe{constructor(t,e,r,s,i){this.bbox=[t,e,r,s],t<r&&console.log("flipX"),s<e&&console.log("flipY"),t<r&&([t,r]=[r,t]),s<e&&([s,e]=[e,s]);const{maxXcor:n,maxYcor:o,minXcor:a,minYcor:h}=i,l=(t-r)/(n-a),c=(s-e)/(o-h),u=(t+r-l*(n+a))/2,d=(s+e-c*(o+h))/2;Object.assign(this,{mx:l,my:c,bx:u,by:d})}toWorld(t){const{mx:e,my:r,bx:s,by:i}=this,[n,o]=t;return[(n-s)/e,(o-i)/r]}toBBox(t){const{mx:e,my:r,bx:s,by:i}=this,[n,o]=t;return[e*n+s,r*o+i]}}const{PI:Oe,atan:ke,atan2:Ie,cos:Te,floor:Re,log:Xe,pow:je,sin:Fe,sinh:Ye,sqrt:De,tan:Ne,abs:Le}=Math,Ue=t=>t*Oe/180;function $e(t,e){return(t+180)/360*je(2,e)}function Be(t,e){return Re($e(t,e))}function We(t,e){const r=Ue(t);return(1-Xe(Ne(r)+1/Te(r))/Oe)*je(2,e-1)}function Ve(t,e){return Re(We(t,e))}function qe(t,e,r){return[$e(t,r),We(e,r)]}function Ze(t,e,r){return[Be(t,r),Ve(e,r)]}function Ge(t,e){return t/je(2,e)*360-180}function He(t,e){return(t=>180*t/Oe)(ke(Ye(Oe-2*Oe*t/je(2,e))))}function Je(t,e,r){return[Ge(t,r),He(e,r)]}function Qe(t,e,r,s=null){const[i,n]=Je(t,e,r),[o,a]=Je(t+1,e+1,r);return s?f([i,a,o,n],s):[i,a,o,n]}function Ke(t){const[e,r,s,i]=t;return[(e+s)/2,(r+i)/2]}function tr(t){const[e,r,s,i]=t;return[[e,i],[s,i],[s,r],[e,r]]}function er(t,e={}){const r=tr(t);return r.push(r[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[r]},properties:e}}function rr(t,e=1,r=e){let[s,i]=t;return[s-e,i-r,s+e,i+r]}const sr=[-105.978,35.66],ir=rr(sr,.2,.1),nr=[-109.050044,31.332301,-103.001964,37.000104],or=Ke(nr),ar=[-124.733174,24.544701,-66.949895,49.384358],hr=Ke(ar);function lr(t){const[e,r,s,i]=t;return[Le(e-s),Le(i-r)]}function cr(t){const[e,r,s,i]=t,n=[e,i],o=[e,r];return[mr(n,[s,i]),mr(n,o)]}function ur(t){const[e,r]=cr(t);return e/r}function dr(t,e,r,s){return"https://overpass-api.de/api/interpreter?data="+encodeURIComponent(`[out:json][timeout:180][bbox:${t},${e},${r},${s}];\nway[highway];\n(._;>;);\nout;`)}function mr(t,e){const[r,s]=t.map((t=>Ue(t))),[i,n]=e.map((t=>Ue(t))),o=i-r,a=Fe((n-s)/2)**2+Te(s)*Te(n)*Fe(o/2)**2;return 1e3*(6378.137*(2*Ie(De(a),De(1-a))))}var pr=Object.freeze({__proto__:null,latlon:function t(e){return"number"!=typeof e[0]?e.map((e=>t(e))):[e[1],e[0]]},lonz2xFloat:$e,lonz2x:Be,latz2yFloat:We,latz2y:Ve,lonlatz2xyFloat:qe,lonlatz2xy:Ze,xz2lon:Ge,yz2lat:He,xyz2lonlat:Je,xyz2centerLonlat:function(t,e,r){return[Ge(t+.5,r),He(e+.5,r)]},xyz2bbox:Qe,xyInBBox:function(t,e){const[r,s,i,n]=t,[o,a]=e;return M(o,r,i)&&M(a,s,n)},lonLatz2bbox:function(t,e,r){const[s,i]=Ze(t,e,r);return Qe(s,i,r)},Lbounds2bbox:function(t){let{lng:e,lat:r}=t.getNorthWest(),{lng:s,lat:i}=t.getSouthEast();return[e,i,s,r]},tilesBBox:function(t,e){const[r,s,i,n]=t,[o,a]=Ze(r,n,e);let[h,l]=qe(i,s,e);return h=Re(h),l=Number.isInteger(l)?l-1:Re(l),[o,l,h,a]},bboxCenter:Ke,bboxCoords:tr,bboxBounds:function(t){const[e,r,s,i]=t;return[[e,i],[s,r]]},bboxFeature:er,bboxFromCenter:rr,santaFeCenter:sr,santaFeBBox:ir,newMexicoBBox:nr,newMexicoCenter:or,usaBBox:ar,usaCenter:hr,bboxSize:lr,bboxAspect:function(t){const[e,r]=lr(t);return e/r},bboxMetricSize:cr,bboxMetricAspect:ur,getOsmURL:dr,bbox2osm:async function(t){const[e,r,s,i]=t,n=dr(r,e,i,s);return await fetch(n).then((t=>t.json()))},lonLat2meters:mr,attribution:function(t="osm"){const e="Map data &copy; ";switch(t){case"osm":return e+'<a href="https://openstreetmap.org">OpenStreetMap</a>';case"topo":return e+'<a href="https://opentopomap.org">OpenTopoMap</a>';case"topo1":return e+'<a  href="https://www.maptiler.com">OpenTopoMap</a>';case"smooth":return e+'<a href="https://stadiamaps.com/">Stadia Maps</a>';case"usgs":return e+'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'}throw Error("gis.attribution: name unknown:",t)},template:function(t="osm"){switch(t){case"osm":return"https://tile.openstreetmap.org/{z}/{x}/{y}.png";case"topo":return"https://a.tile.opentopomap.org/{z}/{x}/{y}.png";case"topo1":return"https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=iQurAP6lArV1UP4gfSVs";case"smooth":return"https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png";case"usgs":return"https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}";case"contour":return"https://api.maptiler.com/tiles/contours/tiles.json?key=iQurAP6lArV1UP4gfSVs"}throw Error("gis.template: name unknown:",t)},url:function(t,e,r,s="osm"){switch(s){case"osm":return`https://tile.openstreetmap.org/${t}/${e}/${r}.png`;case"topo":return`https://tile.opentopomap.org/${t}/${e}/${r}.png`;case"topo1":return`https://api.maptiler.com/maps/topo/${t}/${e}/${r}.png?key=iQurAP6lArV1UP4gfSVs`;case"smooth":return`https://tiles.stadiamaps.com/tiles/alidade_smooth/${t}/${e}/${r}{r}.png`;case"usgs":return`https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/${t}/${r}/${e}`}throw Error("gis.url: name unknown:",s)},elevationTemplate:function(t="mapzen"){switch(t){case"mapzen":return"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png";case"maptiler":return"https://api.maptiler.com/tiles/terrain-rgb/{z}/{x}/{y}.png?key=iQurAP6lArV1UP4gfSVs";case"redfishUSA":return"https://s3-us-west-2.amazonaws.com/simtable-elevation-tiles/{z}/{x}/{y}.png";case"redfishWorld":return"https://s3-us-west-2.amazonaws.com/world-elevation-tiles/DEM_tiles/{z}/{x}/{y}.png";case"mapbox":return"https://api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYmFja3NwYWNlcyIsImEiOiJjanVrbzI4dncwOXl3M3ptcGJtN3oxMmhoIn0.x9iSCrtm0iADEqixVgPwqQ"}throw Error("gis.elevationTemplate: name unknown:",t)}});class gr extends Ee{static defaultOptions(t=nr,e=100){return{bbox:t,patchesWidth:e}}constructor(t=gr.defaultOptions()){let e,{bbox:r,patchesWidth:s}=t;Array.isArray(r)||(e=r,r=ye(e));const i=ur(r),n=Math.round(s/2);super({minX:0,maxX:s-1,minY:0,maxY:Math.round(s/i),minZ:-n,maxZ:n}),this.bbox=r,this.xfm=this.bboxTransform(...r),e&&(this.geojson=e)}toGeo(t,e){return this.xfm.toBBox([t,e])}toWorld(t,e){return this.xfm.toWorld([t,e])}bboxCenter(){return Ke(this.bbox)}bboxCoords(){return tr(this.bbox)}bboxFeature(t={}){return er(this.bbox,t)}}class fr extends _e{constructor(t,e,r){super(t,e,r),this.isBreedSet()||(this.populate(),this.labels=[])}populate(){G(this.model.world.numX*this.model.world.numY,(t=>{this.addAgent()}))}neighborsOffsets(t,e){const{minX:r,maxX:s,minY:i,maxY:n,numX:o}=this.model.world;return t===r?e===i?[-o,1-o,1]:e===n?[1,o+1,o]:[-o,1-o,1,o+1,o]:t===s?e===i?[-o-1,-o,-1]:e===n?[o,o-1,-1]:[-o-1,-o,o,o-1,-1]:e===i?[-o-1,-o,1-o,1,-1]:e===n?[1,o+1,o,o-1,-1]:[-o-1,-o,1-o,1,o+1,o,o-1,-1]}neighbors4Offsets(t,e){const r=this.model.world.numX;return this.neighborsOffsets(t,e).filter((t=>1===Math.abs(t)||Math.abs(t)===r))}neighbors(t){const{id:e,x:r,y:s}=t,i=this.neighborsOffsets(r,s),n=new ze(this.model,i.length);return i.forEach(((t,r)=>{n[r]=this[t+e]})),n}neighbors4(t){const{id:e,x:r,y:s}=t,i=this.neighbors4Offsets(r,s),n=new ze(this.model,i.length);return i.forEach(((t,r)=>{n[r]=this[t+e]})),n}importDataSet(t,e,r=!1){if(this.isBreedSet())return l("Patches: exportDataSet called with breed, using patches"),void this.baseSet.importDataSet(t,e,r);const{numX:s,numY:i}=this.model.world,n=t.resample(s,i,r);this.ask((t=>{t[e]=n.data[t.id]}))}exportDataSet(t,e=Array){if(this.isBreedSet())return l("Patches: exportDataSet called with breed, using patches"),this.baseSet.exportDataSet(t,e);const{numX:r,numY:s}=this.model.world;let i=this.props(t);return i=_t(i,e),new Se(r,s,i)}patchIndex(t,e){const{minX:r,maxY:s,numX:i}=this.model.world;return t-r+i*(s-e)}patch(t,e){if(!this.model.world.isOnWorld(t,e))return;const r=t===this.model.world.maxXcor?this.model.world.maxX:Math.round(t),s=e===this.model.world.maxYcor?this.model.world.maxY:Math.round(e);return this.patchXY(r,s)}patchXY(t,e){return this[this.patchIndex(t,e)]}patchRect(t,e,r=e,s=!0){if(t.rectCache){const i=this.cacheIndex(e,r,s),n=t.rectCache[i];if(n)return n}const i=new ze(this.model);let{minX:n,maxX:o,minY:a,maxY:h}=this.model.world;n=Math.max(n,t.x-e),o=Math.min(o,t.x+e),a=Math.max(a,t.y-r),h=Math.min(h,t.y+r);for(let e=a;e<=h;e++)for(let r=n;r<=o;r++){const n=this.patchXY(r,e);(t!==n||s)&&i.push(n)}return i}patchRectXY(t,e,r,s=r,i=!0){return this.patchRect(this.patch(t,e),r,s,i)}cacheIndex(t,e=t,r=!0){return(2*t+1)*(2*e+1)+(r?0:-1)}cacheRect(t,e=t,r=!0,s=!0){const i=this.cacheIndex(t,e,r);this.ask((n=>{n.rectCache&&!s||(n.rectCache=[]);const o=this.inRect(n,t,e,r);n.rectCache[i]=o}))}inRect(t,e,r=e,s=!0){const i=this.patchRect(t,e,r,s);return this.isBaseSet()?i:i.withBreed(this)}inRadius(t,e,r=!0){const s=Math.ceil(e);return this.inRect(t,s,s,r).inRadius(t,e,r)}inCone(t,e,r,s,i=!0){const n=Math.ceil(e);return this.inRect(t,n,n,i).inCone(t,e,r,s,i)}patchAtHeadingAndDistance(t,e,r){e=this.model.toRads(e);let{x:s,y:i}=t;return s+=r*Math.cos(e),i+=r*Math.sin(e),this.patch(s,i)}isOnEdge(t){const{x:e,y:r}=t,{minX:s,maxX:i,minY:n,maxY:o}=this.model.world;return e===s||e===i||r===n||r===o}edgePatches(){return this.filter((t=>this.isOnEdge(t)))}diffuse(t,e){this.diffuseN(8,t,e)}diffuse4(t,e){this.diffuseN(4,t,e)}diffuseN(t,e,r){if(void 0===this[0]._diffuseNext)for(let t=0;t<this.length;t++)this[t]._diffuseNext=0;for(let s=0;s<this.length;s++){const i=this[s],n=i[e]*r,o=n/t,a=8===t?i.neighbors:i.neighbors4,h=a.length;i._diffuseNext+=i[e]-n+(t-h)*o;for(let t=0;t<a.length;t++)a[t]._diffuseNext+=o}for(let t=0;t<this.length;t++){const r=this[t];r[e]=r._diffuseNext,r._diffuseNext=0}}}class yr{agentSet;model;name;turtles;z=0;get x(){return this.id%this.model.world.width+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.width)}isOnEdge(){return this.patches.isOnEdge(this)}get neighbors(){const t=this.patches.neighbors(this);return Object.defineProperty(this,"neighbors",{value:t,enumerable:!0}),t}get neighbors4(){const t=this.patches.neighbors4(this);return Object.defineProperty(this,"neighbors4",{value:t,enumerable:!0}),t}get turtlesHere(){return null==this.turtles&&(this.patches.ask((t=>{t.turtles=new ze(this.model)})),this.model.turtles.ask((t=>{t.patch.turtles.push(t)}))),this.turtles}breedsHere(t){return this.turtlesHere.withBreed(t)}distanceXY(t,e,r=null){return null!=r&&null!=this.z?L(this.x,this.y,this.z,t,e,r):D(this.x,this.y,t,e)}distance(t){const{x:e,y:r,z:s}=t;return this.distanceXY(e,r,s)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){let r=j(this.x,this.y,t,e);return this.model.fromRads(r)}patchAt(t,e){return this.patches.patch(this.x+t,this.y+e)}patchAtHeadingAndDistance(t,e){return this.patches.patchAtHeadingAndDistance(this,t,e)}sprout(t=1,e=this.model.turtles,r=(t=>{})){return e.create(t,(t=>{t.setxy(this.x,this.y),r(t)}))}}class xr extends _e{constructor(t,e,r,s=null){super(t,e,r,s)}createOne(t=(t=>{})){const e=this.addAgent();e.heading=this.model.fromRads(m(2*Math.PI));const r=e.patch;return null!=r.turtles&&r.turtles.push(e),t(e),e}create(t,e=(t=>{})){return G(t,((t,r)=>{r.push(this.createOne(e))}))}closestTurtle(t,e,r){const s=this.inPatchRectXY(t,e,r);return 0===s.length?null:s.minOneOf((r=>r.distanceXY(t,e)))}inPatches(t){let e=new ze(this.model);for(const r of t)e.push(...r.turtlesHere);return this.isBreedSet()&&(e=e.filter((t=>t.agentSet===this))),e}inPatchRect(t,e,r=e,s=!1){const i=this.inPatchRectXY(t.x,t.y,e,r);return s||V(i,t),i}inPatchRectXY(t,e,r,s=r){const i=this.model.patches.patchRectXY(t,e,r,s,!0);return this.inPatches(i)}inRadius(t,e,r=!1){return this.inPatchRect(t,e,e,!0).inRadius(t,e,r)}inCone(t,e,r,s=!1){return this.inPatchRect(t,e,e,!0).inCone(t,e,r,t.heading,s)}layoutCircle(t=.9*this.model.world.maxX,e=[0,0]){const r=Math.PI/2,s=2*Math.PI/this.length,[i,n]=e;this.ask(((e,o)=>{e.setxy(i,n),e.theta=r+-1*s*o,e.forward(t)}))}}class wr{atEdge="wrap";hidden=!1;agentSet;model;name;agentConstructor(){this.theta=null,this.x=0,this.y=0,this.agentSet.setDefault("z",null)}die(){if(-1!==this.id){if(this.agentSet.removeAgent(this),this.hasOwnProperty("links"))for(;this.links.length>0;)this.links[0].die();this.patch&&this.patch.turtles&&V(this.patch.turtles,this),this.id=-1}}isDead(){return-1===this.id}hatch(t=1,e=this.agentSet,r=(t=>{})){return e.create(t,(t=>{t.setxy(this.x,this.y,this.z),t.theta=this.theta;for(const r of e.ownVariables)null==t[r]&&(t[r]=this[r]);r(t)}))}get links(){return Object.defineProperty(this,"links",{value:new ze(this.model),enumerable:!0}),this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return this.model.fromRads(this.theta)}set heading(t){this.theta=this.model.toRads(t)}subtractHeading(t){return X(t,this.heading)}setxy(t,e,r){const s=this.patch;this.x=t,this.y=e,null!=r&&(this.z=r),this.checkXYZ(s)}checkXYZ(t){this.checkEdge(),this.checkPatch(t)}checkEdge(){const{x:t,y:e,z:r}=this;this.model.world.isOnWorld(t,e,r)||"OK"===this.atEdge||this.handleEdge(t,e,r)}checkPatch(t){const e=this.patch;e!=t&&(t&&t.turtles&&V(t.turtles,this),e&&e.turtles&&e.turtles.push(this))}handleEdge(t,e,r){let s=this.atEdge;if(pt(s)){const{minXcor:i,maxXcor:n,minYcor:o,maxYcor:a,minZcor:h,maxZcor:l}=this.model.world;if("wrap"===s)this.x=w(t,i,n),this.y=w(e,o,a),null!=r&&(this.z=w(r,h,l));else if("die"===s)this.die();else if("random"===s)this.setxy(...this.model.world.randomPoint());else{if("clamp"!==s&&"bounce"!==s)throw Error(`turtle.handleEdge: bad atEdge: ${s}`);this.x=b(t,i,n),this.y=b(e,o,a),null!=r&&(this.z=b(r,h,l)),"bounce"===s&&(this.x===i||this.x===n?this.theta=Math.PI-this.theta:this.y===o||this.y===a?this.theta=-this.theta:this.z!==h&&this.z!==l||(this.pitch?this.pitch=-this.pitch:this.z=w(r,h,l)))}}else this.atEdge(this)}moveTo(t){this.setxy(t.x,t.y,t.z)}forward(t){this.setxy(this.x+t*Math.cos(this.theta),this.y+t*Math.sin(this.theta))}rotate(t){t=this.model.toCCW(t),this.heading+=t}right(t){this.rotate(-t)}left(t){this.rotate(t)}face(t){this.heading=this.towards(t)}facexy(t,e){this.heading=this.towardsXY(t,e)}patchAhead(t){return this.patchAtHeadingAndDistance(this.heading,t)}patchRightAndAhead(t,e){return t=this.model.toCCW(t),this.patchAtHeadingAndDistance(this.heading-t,e)}patchLeftAndAhead(t,e){return this.patchRightAndAhead(-t,e)}canMove(t){return null!=this.patchAhead(t)}distanceXY(t,e,r=null){return null!=r&&null!=this.z?L(this.x,this.y,this.z,t,e,r):D(this.x,this.y,t,e)}distance(t){const{x:e,y:r,z:s}=t;return this.distanceXY(e,r,s)}get dx(){return Math.cos(this.theta)}get dy(){return Math.sin(this.theta)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){let r=j(this.x,this.y,t,e);return this.model.fromRads(r)}patchAt(t,e){return this.model.patches.patch(this.x+t,this.y+e)}patchAtHeadingAndDistance(t,e){return this.model.patches.patchAtHeadingAndDistance(this,t,e)}otherEnd(t){return t.end0===this?t.end1:t.end0}linkNeighbors(){return this.links.map((t=>this.otherEnd(t)))}isLinkNeighbor(t){return t in this.linkNeighbors()}}class br{world;patches;turtles;links;ticks;constructor(t=Ee.defaultOptions()){this.resetModel(t),this.setAutoTick(!0),this.setGeometry("heading")}initAgentSet(t,e,r){this[t]=new e(this,r,t)}options2world(t){return t.bbox?new gr(t):new Ee(t)}resetModel(t){this.ticks=0,this.world=void 0===t.maxXcor?this.options2world(t):t,this.initAgentSet("patches",fr,yr),this.initAgentSet("turtles",xr,wr),this.initAgentSet("links",Ae,Ce)}reset(t=this.world){this.resetModel(t)}tick(){this.ticks++}async startup(){}setup(){}step(){}setAutoTick(t=!0){const e=this.hasOwnProperty("step");if(t){if(e)return;this.step0=this.step,this.step=this.stepAndTick}else delete this.step,delete this.step0}stepAndTick(){this.step0(),this.tick()}patchBreeds(t){for(const e of t.split(" "))this[e]=this.patches.newBreed(e)}turtleBreeds(t){for(const e of t.split(" "))this[e]=this.turtles.newBreed(e)}linkBreeds(t){for(const e of t.split(" "))this[e]=this.links.newBreed(e)}setGeometry(t="heading"){const e=zr[t];if(!e)throw Error(`setGeometry: ${t} geometry not defined`);Object.assign(this,e)}}const Mr=180/Math.PI,vr=Math.PI/180,zr={radians:{toRads:t=>t,fromRads:t=>t,toAngleRads:t=>t,fromAngleRads:t=>t,toCCW:t=>t},degrees:{toRads:t=>t*vr,fromRads:t=>t*Mr,toAngleRads:t=>t*vr,fromAngleRads:t=>t*Mr,toCCW:t=>t},heading:{toRads:t=>(90-t)*vr,fromRads:t=>90-t*Mr,toAngleRads:t=>t*vr,fromAngleRads:t=>t*Mr,toCCW:t=>-t}},_r=[];for(let t=0;t<256;t++)_r[t]=(t<16?"0":"")+t.toString(16);let Sr=1234567;const Cr={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(_r[255&t]+_r[t>>8&255]+_r[t>>16&255]+_r[t>>24&255]+"-"+_r[255&e]+_r[e>>8&255]+"-"+_r[e>>16&15|64]+_r[e>>24&255]+"-"+_r[63&r|128]+_r[r>>8&255]+"-"+_r[r>>16&255]+_r[r>>24&255]+_r[255&s]+_r[s>>8&255]+_r[s>>16&255]+_r[s>>24&255]).toUpperCase()},clamp:function(t,e,r){return Math.max(e,Math.min(r,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,r,s,i){return s+(t-e)*(i-s)/(r-e)},lerp:function(t,e,r){return(1-r)*t+r*e},smoothstep:function(t,e,r){return t<=e?0:t>=r?1:(t=(t-e)/(r-e))*t*(3-2*t)},smootherstep:function(t,e,r){return t<=e?0:t>=r?1:(t=(t-e)/(r-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){return void 0!==t&&(Sr=t%2147483647),Sr=16807*Sr%2147483647,(Sr-1)/2147483646},degToRad:function(t){return t*Cr.DEG2RAD},radToDeg:function(t){return t*Cr.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,r,s,i){const n=Math.cos,o=Math.sin,a=n(r/2),h=o(r/2),l=n((e+s)/2),c=o((e+s)/2),u=n((e-s)/2),d=o((e-s)/2),m=n((s-e)/2),p=o((s-e)/2);switch(i){case"XYX":t.set(a*c,h*u,h*d,a*l);break;case"YZY":t.set(h*d,a*c,h*u,a*l);break;case"ZXZ":t.set(h*u,h*d,a*c,a*l);break;case"XZX":t.set(a*c,h*p,h*m,a*l);break;case"YXY":t.set(h*m,a*c,h*p,a*l);break;case"ZYZ":t.set(h*p,h*m,a*c,a*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+i)}}};class Ar{constructor(t=0,e=0,r=0,s=1){Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=t,this._y=e,this._z=r,this._w=s}static slerp(t,e,r,s){return r.copy(t).slerp(e,s)}static slerpFlat(t,e,r,s,i,n,o){let a=r[s+0],h=r[s+1],l=r[s+2],c=r[s+3];const u=i[n+0],d=i[n+1],m=i[n+2],p=i[n+3];if(c!==p||a!==u||h!==d||l!==m){let t=1-o;const e=a*u+h*d+l*m+c*p,r=e>=0?1:-1,s=1-e*e;if(s>Number.EPSILON){const i=Math.sqrt(s),n=Math.atan2(i,e*r);t=Math.sin(t*n)/i,o=Math.sin(o*n)/i}const i=o*r;if(a=a*t+u*i,h=h*t+d*i,l=l*t+m*i,c=c*t+p*i,t===1-o){const t=1/Math.sqrt(a*a+h*h+l*l+c*c);a*=t,h*=t,l*=t,c*=t}}t[e]=a,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,r,s,i,n){const o=r[s],a=r[s+1],h=r[s+2],l=r[s+3],c=i[n],u=i[n+1],d=i[n+2],m=i[n+3];return t[e]=o*m+l*c+a*d-h*u,t[e+1]=a*m+l*u+h*c-o*d,t[e+2]=h*m+l*d+o*u-a*c,t[e+3]=l*m-o*c-a*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,r,s){return this._x=t,this._y=e,this._z=r,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const r=t._x,s=t._y,i=t._z,n=t._order,o=Math.cos,a=Math.sin,h=o(r/2),l=o(s/2),c=o(i/2),u=a(r/2),d=a(s/2),m=a(i/2);switch(n){case"XYZ":this._x=u*l*c+h*d*m,this._y=h*d*c-u*l*m,this._z=h*l*m+u*d*c,this._w=h*l*c-u*d*m;break;case"YXZ":this._x=u*l*c+h*d*m,this._y=h*d*c-u*l*m,this._z=h*l*m-u*d*c,this._w=h*l*c+u*d*m;break;case"ZXY":this._x=u*l*c-h*d*m,this._y=h*d*c+u*l*m,this._z=h*l*m+u*d*c,this._w=h*l*c-u*d*m;break;case"ZYX":this._x=u*l*c-h*d*m,this._y=h*d*c+u*l*m,this._z=h*l*m-u*d*c,this._w=h*l*c+u*d*m;break;case"YZX":this._x=u*l*c+h*d*m,this._y=h*d*c+u*l*m,this._z=h*l*m-u*d*c,this._w=h*l*c-u*d*m;break;case"XZY":this._x=u*l*c-h*d*m,this._y=h*d*c-u*l*m,this._z=h*l*m+u*d*c,this._w=h*l*c+u*d*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const r=e/2,s=Math.sin(r);return this._x=t.x*s,this._y=t.y*s,this._z=t.z*s,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,r=e[0],s=e[4],i=e[8],n=e[1],o=e[5],a=e[9],h=e[2],l=e[6],c=e[10],u=r+o+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-a)*t,this._y=(i-h)*t,this._z=(n-s)*t}else if(r>o&&r>c){const t=2*Math.sqrt(1+r-o-c);this._w=(l-a)/t,this._x=.25*t,this._y=(s+n)/t,this._z=(i+h)/t}else if(o>c){const t=2*Math.sqrt(1+o-r-c);this._w=(i-h)/t,this._x=(s+n)/t,this._y=.25*t,this._z=(a+l)/t}else{const t=2*Math.sqrt(1+c-r-o);this._w=(n-s)/t,this._x=(i+h)/t,this._y=(a+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let r=t.dot(e)+1;return r<1e-6?(r=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=r):(this._x=0,this._y=-t.z,this._z=t.y,this._w=r)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=r),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(Cr.clamp(this.dot(t),-1,1)))}rotateTowards(t,e){const r=this.angleTo(t);if(0===r)return this;const s=Math.min(1,e/r);return this.slerp(t,s),this}identity(){return this.set(0,0,0,1)}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const r=t._x,s=t._y,i=t._z,n=t._w,o=e._x,a=e._y,h=e._z,l=e._w;return this._x=r*l+n*o+s*h-i*a,this._y=s*l+n*a+i*o-r*h,this._z=i*l+n*h+r*a-s*o,this._w=n*l-r*o-s*a-i*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const r=this._x,s=this._y,i=this._z,n=this._w;let o=n*t._w+r*t._x+s*t._y+i*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=n,this._x=r,this._y=s,this._z=i,this;const a=1-o*o;if(a<=Number.EPSILON){const t=1-e;return this._w=t*n+e*this._w,this._x=t*r+e*this._x,this._y=t*s+e*this._y,this._z=t*i+e*this._z,this.normalize(),this._onChangeCallback(),this}const h=Math.sqrt(a),l=Math.atan2(h,o),c=Math.sin((1-e)*l)/h,u=Math.sin(e*l)/h;return this._w=n*c+this._w*u,this._x=r*c+this._x*u,this._y=s*c+this._y*u,this._z=i*c+this._z*u,this._onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}class Er{constructor(t=0,e=0,r=0){Object.defineProperty(this,"isVector3",{value:!0}),this.x=t,this.y=e,this.z=r}set(t,e,r){return void 0===r&&(r=this.z),this.x=t,this.y=e,this.z=r,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Or.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Or.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,r=this.y,s=this.z,i=t.elements;return this.x=i[0]*e+i[3]*r+i[6]*s,this.y=i[1]*e+i[4]*r+i[7]*s,this.z=i[2]*e+i[5]*r+i[8]*s,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,r=this.y,s=this.z,i=t.elements,n=1/(i[3]*e+i[7]*r+i[11]*s+i[15]);return this.x=(i[0]*e+i[4]*r+i[8]*s+i[12])*n,this.y=(i[1]*e+i[5]*r+i[9]*s+i[13])*n,this.z=(i[2]*e+i[6]*r+i[10]*s+i[14])*n,this}applyQuaternion(t){const e=this.x,r=this.y,s=this.z,i=t.x,n=t.y,o=t.z,a=t.w,h=a*e+n*s-o*r,l=a*r+o*e-i*s,c=a*s+i*r-n*e,u=-i*e-n*r-o*s;return this.x=h*a+u*-i+l*-o-c*-n,this.y=l*a+u*-n+c*-i-h*-o,this.z=c*a+u*-o+h*-n-l*-i,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,r=this.y,s=this.z,i=t.elements;return this.x=i[0]*e+i[4]*r+i[8]*s,this.y=i[1]*e+i[5]*r+i[9]*s,this.z=i[2]*e+i[6]*r+i[10]*s,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(e,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const r=t.x,s=t.y,i=t.z,n=e.x,o=e.y,a=e.z;return this.x=s*a-i*o,this.y=i*n-r*a,this.z=r*o-s*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const r=t.dot(this)/e;return this.copy(t).multiplyScalar(r)}projectOnPlane(t){return Pr.copy(this).projectOnVector(t),this.sub(Pr)}reflect(t){return this.sub(Pr.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(Cr.clamp(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y,s=this.z-t.z;return e*e+r*r+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,r){const s=Math.sin(e)*t;return this.x=s*Math.sin(r),this.y=Math.cos(e)*t,this.z=s*Math.cos(r),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,r){return this.x=t*Math.sin(e),this.y=r,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),r=this.setFromMatrixColumn(t,1).length(),s=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=r,this.z=s,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}const Pr=new Er,Or=new Ar;class kr{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,r,s,i,n,o,a,h,l,c,u,d,m,p,g){const f=this.elements;return f[0]=t,f[4]=e,f[8]=r,f[12]=s,f[1]=i,f[5]=n,f[9]=o,f[13]=a,f[2]=h,f[6]=l,f[10]=c,f[14]=u,f[3]=d,f[7]=m,f[11]=p,f[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new kr).fromArray(this.elements)}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}copyPosition(t){const e=this.elements,r=t.elements;return e[12]=r[12],e[13]=r[13],e[14]=r[14],this}extractBasis(t,e,r){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(t,e,r){return this.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,r=t.elements,s=1/Ir.setFromMatrixColumn(t,0).length(),i=1/Ir.setFromMatrixColumn(t,1).length(),n=1/Ir.setFromMatrixColumn(t,2).length();return e[0]=r[0]*s,e[1]=r[1]*s,e[2]=r[2]*s,e[3]=0,e[4]=r[4]*i,e[5]=r[5]*i,e[6]=r[6]*i,e[7]=0,e[8]=r[8]*n,e[9]=r[9]*n,e[10]=r[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,r=t.x,s=t.y,i=t.z,n=Math.cos(r),o=Math.sin(r),a=Math.cos(s),h=Math.sin(s),l=Math.cos(i),c=Math.sin(i);if("XYZ"===t.order){const t=n*l,r=n*c,s=o*l,i=o*c;e[0]=a*l,e[4]=-a*c,e[8]=h,e[1]=r+s*h,e[5]=t-i*h,e[9]=-o*a,e[2]=i-t*h,e[6]=s+r*h,e[10]=n*a}else if("YXZ"===t.order){const t=a*l,r=a*c,s=h*l,i=h*c;e[0]=t+i*o,e[4]=s*o-r,e[8]=n*h,e[1]=n*c,e[5]=n*l,e[9]=-o,e[2]=r*o-s,e[6]=i+t*o,e[10]=n*a}else if("ZXY"===t.order){const t=a*l,r=a*c,s=h*l,i=h*c;e[0]=t-i*o,e[4]=-n*c,e[8]=s+r*o,e[1]=r+s*o,e[5]=n*l,e[9]=i-t*o,e[2]=-n*h,e[6]=o,e[10]=n*a}else if("ZYX"===t.order){const t=n*l,r=n*c,s=o*l,i=o*c;e[0]=a*l,e[4]=s*h-r,e[8]=t*h+i,e[1]=a*c,e[5]=i*h+t,e[9]=r*h-s,e[2]=-h,e[6]=o*a,e[10]=n*a}else if("YZX"===t.order){const t=n*a,r=n*h,s=o*a,i=o*h;e[0]=a*l,e[4]=i-t*c,e[8]=s*c+r,e[1]=c,e[5]=n*l,e[9]=-o*l,e[2]=-h*l,e[6]=r*c+s,e[10]=t-i*c}else if("XZY"===t.order){const t=n*a,r=n*h,s=o*a,i=o*h;e[0]=a*l,e[4]=-c,e[8]=h*l,e[1]=t*c+i,e[5]=n*l,e[9]=r*c-s,e[2]=s*c-r,e[6]=o*l,e[10]=i*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Rr,t,Xr)}lookAt(t,e,r){const s=this.elements;return Yr.subVectors(t,e),0===Yr.lengthSq()&&(Yr.z=1),Yr.normalize(),jr.crossVectors(r,Yr),0===jr.lengthSq()&&(1===Math.abs(r.z)?Yr.x+=1e-4:Yr.z+=1e-4,Yr.normalize(),jr.crossVectors(r,Yr)),jr.normalize(),Fr.crossVectors(Yr,jr),s[0]=jr.x,s[4]=Fr.x,s[8]=Yr.x,s[1]=jr.y,s[5]=Fr.y,s[9]=Yr.y,s[2]=jr.z,s[6]=Fr.z,s[10]=Yr.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,s=e.elements,i=this.elements,n=r[0],o=r[4],a=r[8],h=r[12],l=r[1],c=r[5],u=r[9],d=r[13],m=r[2],p=r[6],g=r[10],f=r[14],y=r[3],x=r[7],w=r[11],b=r[15],M=s[0],v=s[4],z=s[8],_=s[12],S=s[1],C=s[5],A=s[9],E=s[13],P=s[2],O=s[6],k=s[10],I=s[14],T=s[3],R=s[7],X=s[11],j=s[15];return i[0]=n*M+o*S+a*P+h*T,i[4]=n*v+o*C+a*O+h*R,i[8]=n*z+o*A+a*k+h*X,i[12]=n*_+o*E+a*I+h*j,i[1]=l*M+c*S+u*P+d*T,i[5]=l*v+c*C+u*O+d*R,i[9]=l*z+c*A+u*k+d*X,i[13]=l*_+c*E+u*I+d*j,i[2]=m*M+p*S+g*P+f*T,i[6]=m*v+p*C+g*O+f*R,i[10]=m*z+p*A+g*k+f*X,i[14]=m*_+p*E+g*I+f*j,i[3]=y*M+x*S+w*P+b*T,i[7]=y*v+x*C+w*O+b*R,i[11]=y*z+x*A+w*k+b*X,i[15]=y*_+x*E+w*I+b*j,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[4],s=t[8],i=t[12],n=t[1],o=t[5],a=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+i*a*c-s*h*c-i*o*u+r*h*u+s*o*d-r*a*d)+t[7]*(+e*a*d-e*h*u+i*n*u-s*n*d+s*h*l-i*a*l)+t[11]*(+e*h*c-e*o*d-i*n*c+r*n*d+i*o*l-r*h*l)+t[15]*(-s*o*l-e*a*c+e*o*u+s*n*c-r*n*u+r*a*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,r){const s=this.elements;return t.isVector3?(s[12]=t.x,s[13]=t.y,s[14]=t.z):(s[12]=t,s[13]=e,s[14]=r),this}getInverse(t,e){void 0!==e&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");const r=this.elements,s=t.elements,i=s[0],n=s[1],o=s[2],a=s[3],h=s[4],l=s[5],c=s[6],u=s[7],d=s[8],m=s[9],p=s[10],g=s[11],f=s[12],y=s[13],x=s[14],w=s[15],b=m*x*u-y*p*u+y*c*g-l*x*g-m*c*w+l*p*w,M=f*p*u-d*x*u-f*c*g+h*x*g+d*c*w-h*p*w,v=d*y*u-f*m*u+f*l*g-h*y*g-d*l*w+h*m*w,z=f*m*c-d*y*c-f*l*p+h*y*p+d*l*x-h*m*x,_=i*b+n*M+o*v+a*z;if(0===_)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/_;return r[0]=b*S,r[1]=(y*p*a-m*x*a-y*o*g+n*x*g+m*o*w-n*p*w)*S,r[2]=(l*x*a-y*c*a+y*o*u-n*x*u-l*o*w+n*c*w)*S,r[3]=(m*c*a-l*p*a-m*o*u+n*p*u+l*o*g-n*c*g)*S,r[4]=M*S,r[5]=(d*x*a-f*p*a+f*o*g-i*x*g-d*o*w+i*p*w)*S,r[6]=(f*c*a-h*x*a-f*o*u+i*x*u+h*o*w-i*c*w)*S,r[7]=(h*p*a-d*c*a+d*o*u-i*p*u-h*o*g+i*c*g)*S,r[8]=v*S,r[9]=(f*m*a-d*y*a-f*n*g+i*y*g+d*n*w-i*m*w)*S,r[10]=(h*y*a-f*l*a+f*n*u-i*y*u-h*n*w+i*l*w)*S,r[11]=(d*l*a-h*m*a-d*n*u+i*m*u+h*n*g-i*l*g)*S,r[12]=z*S,r[13]=(d*y*o-f*m*o+f*n*p-i*y*p-d*n*x+i*m*x)*S,r[14]=(f*l*o-h*y*o-f*n*c+i*y*c+h*n*x-i*l*x)*S,r[15]=(h*m*o-d*l*o+d*n*c-i*m*c-h*n*p+i*l*p)*S,this}scale(t){const e=this.elements,r=t.x,s=t.y,i=t.z;return e[0]*=r,e[4]*=s,e[8]*=i,e[1]*=r,e[5]*=s,e[9]*=i,e[2]*=r,e[6]*=s,e[10]*=i,e[3]*=r,e[7]*=s,e[11]*=i,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],s=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,s))}makeTranslation(t,e,r){return this.set(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const r=Math.cos(e),s=Math.sin(e),i=1-r,n=t.x,o=t.y,a=t.z,h=i*n,l=i*o;return this.set(h*n+r,h*o-s*a,h*a+s*o,0,h*o+s*a,l*o+r,l*a-s*n,0,h*a-s*o,l*a+s*n,i*a*a+r,0,0,0,0,1),this}makeScale(t,e,r){return this.set(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1),this}makeShear(t,e,r){return this.set(1,e,r,0,t,1,r,0,t,e,1,0,0,0,0,1),this}compose(t,e,r){const s=this.elements,i=e._x,n=e._y,o=e._z,a=e._w,h=i+i,l=n+n,c=o+o,u=i*h,d=i*l,m=i*c,p=n*l,g=n*c,f=o*c,y=a*h,x=a*l,w=a*c,b=r.x,M=r.y,v=r.z;return s[0]=(1-(p+f))*b,s[1]=(d+w)*b,s[2]=(m-x)*b,s[3]=0,s[4]=(d-w)*M,s[5]=(1-(u+f))*M,s[6]=(g+y)*M,s[7]=0,s[8]=(m+x)*v,s[9]=(g-y)*v,s[10]=(1-(u+p))*v,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,this}decompose(t,e,r){const s=this.elements;let i=Ir.set(s[0],s[1],s[2]).length();const n=Ir.set(s[4],s[5],s[6]).length(),o=Ir.set(s[8],s[9],s[10]).length();this.determinant()<0&&(i=-i),t.x=s[12],t.y=s[13],t.z=s[14],Tr.copy(this);const a=1/i,h=1/n,l=1/o;return Tr.elements[0]*=a,Tr.elements[1]*=a,Tr.elements[2]*=a,Tr.elements[4]*=h,Tr.elements[5]*=h,Tr.elements[6]*=h,Tr.elements[8]*=l,Tr.elements[9]*=l,Tr.elements[10]*=l,e.setFromRotationMatrix(Tr),r.x=i,r.y=n,r.z=o,this}makePerspective(t,e,r,s,i,n){void 0===n&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.elements,a=2*i/(e-t),h=2*i/(r-s),l=(e+t)/(e-t),c=(r+s)/(r-s),u=-(n+i)/(n-i),d=-2*n*i/(n-i);return o[0]=a,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=h,o[9]=c,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,r,s,i,n){const o=this.elements,a=1/(e-t),h=1/(r-s),l=1/(n-i),c=(e+t)*a,u=(r+s)*h,d=(n+i)*l;return o[0]=2*a,o[4]=0,o[8]=0,o[12]=-c,o[1]=0,o[5]=2*h,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,r=t.elements;for(let t=0;t<16;t++)if(e[t]!==r[t])return!1;return!0}fromArray(t,e){void 0===e&&(e=0);for(let r=0;r<16;r++)this.elements[r]=t[r+e];return this}toArray(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15],t}}const Ir=new Er,Tr=new kr,Rr=new Er(0,0,0),Xr=new Er(1,1,1),jr=new Er,Fr=new Er,Yr=new Er;function Dr(){}Object.assign(Dr.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});const r=this._listeners;void 0===r[t]&&(r[t]=[]),-1===r[t].indexOf(e)&&r[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;const r=this._listeners;return void 0!==r[t]&&-1!==r[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return;const r=this._listeners[t];if(void 0!==r){const t=r.indexOf(e);-1!==t&&r.splice(t,1)}},dispatchEvent:function(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const r=e.slice(0);for(let e=0,s=r.length;e<s;e++)r[e].call(this,t)}}});class Nr{constructor(t=0,e=0,r=0,s=Nr.DefaultOrder){Object.defineProperty(this,"isEuler",{value:!0}),this._x=t,this._y=e,this._z=r,this._order=s}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,r,s){return this._x=t,this._y=e,this._z=r,this._order=s||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e,r){const s=Cr.clamp,i=t.elements,n=i[0],o=i[4],a=i[8],h=i[1],l=i[5],c=i[9],u=i[2],d=i[6],m=i[10];switch(e=e||this._order){case"XYZ":this._y=Math.asin(s(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,m),this._z=Math.atan2(-o,n)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-s(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(a,m),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-u,n),this._z=0);break;case"ZXY":this._x=Math.asin(s(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,m),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(h,n));break;case"ZYX":this._y=Math.asin(-s(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,m),this._z=Math.atan2(h,n)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(s(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,n)):(this._x=0,this._y=Math.atan2(a,m));break;case"XZY":this._z=Math.asin(-s(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(a,n)):(this._x=Math.atan2(-c,m),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!1!==r&&this._onChangeCallback(),this}setFromQuaternion(t,e,r){return Lr.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Lr,e,r)}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}reorder(t){return Ur.setFromEuler(this),this.setFromQuaternion(Ur,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new Er(this._x,this._y,this._z)}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}Nr.DefaultOrder="XYZ",Nr.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const Lr=new kr,Ur=new Ar;class $r{constructor(){this.mask=1}set(t){this.mask=1<<t|0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}}class Br{constructor(){Object.defineProperty(this,"isMatrix3",{value:!0}),this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,r,s,i,n,o,a,h){const l=this.elements;return l[0]=t,l[1]=s,l[2]=o,l[3]=e,l[4]=i,l[5]=a,l[6]=r,l[7]=n,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new this.constructor).fromArray(this.elements)}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this}extractBasis(t,e,r){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,s=e.elements,i=this.elements,n=r[0],o=r[3],a=r[6],h=r[1],l=r[4],c=r[7],u=r[2],d=r[5],m=r[8],p=s[0],g=s[3],f=s[6],y=s[1],x=s[4],w=s[7],b=s[2],M=s[5],v=s[8];return i[0]=n*p+o*y+a*b,i[3]=n*g+o*x+a*M,i[6]=n*f+o*w+a*v,i[1]=h*p+l*y+c*b,i[4]=h*g+l*x+c*M,i[7]=h*f+l*w+c*v,i[2]=u*p+d*y+m*b,i[5]=u*g+d*x+m*M,i[8]=u*f+d*w+m*v,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[1],s=t[2],i=t[3],n=t[4],o=t[5],a=t[6],h=t[7],l=t[8];return e*n*l-e*o*h-r*i*l+r*o*a+s*i*h-s*n*a}getInverse(t,e){void 0!==e&&console.warn("THREE.Matrix3: .getInverse() can no longer be configured to throw on degenerate.");const r=t.elements,s=this.elements,i=r[0],n=r[1],o=r[2],a=r[3],h=r[4],l=r[5],c=r[6],u=r[7],d=r[8],m=d*h-l*u,p=l*c-d*a,g=u*a-h*c,f=i*m+n*p+o*g;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);const y=1/f;return s[0]=m*y,s[1]=(o*u-d*n)*y,s[2]=(l*n-o*h)*y,s[3]=p*y,s[4]=(d*i-o*c)*y,s[5]=(o*a-l*i)*y,s[6]=g*y,s[7]=(n*c-u*i)*y,s[8]=(h*i-n*a)*y,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).getInverse(this).transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,r,s,i,n,o){const a=Math.cos(i),h=Math.sin(i);this.set(r*a,r*h,-r*(a*n+h*o)+n+t,-s*h,s*a,-s*(-h*n+a*o)+o+e,0,0,1)}scale(t,e){const r=this.elements;return r[0]*=t,r[3]*=t,r[6]*=t,r[1]*=e,r[4]*=e,r[7]*=e,this}rotate(t){const e=Math.cos(t),r=Math.sin(t),s=this.elements,i=s[0],n=s[3],o=s[6],a=s[1],h=s[4],l=s[7];return s[0]=e*i+r*a,s[3]=e*n+r*h,s[6]=e*o+r*l,s[1]=-r*i+e*a,s[4]=-r*n+e*h,s[7]=-r*o+e*l,this}translate(t,e){const r=this.elements;return r[0]+=t*r[2],r[3]+=t*r[5],r[6]+=t*r[8],r[1]+=e*r[2],r[4]+=e*r[5],r[7]+=e*r[8],this}equals(t){const e=this.elements,r=t.elements;for(let t=0;t<9;t++)if(e[t]!==r[t])return!1;return!0}fromArray(t,e){void 0===e&&(e=0);for(let r=0;r<9;r++)this.elements[r]=t[r+e];return this}toArray(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t}}let Wr=0;const Vr=new Er,qr=new Ar,Zr=new kr,Gr=new Er,Hr=new Er,Jr=new Er,Qr=new Ar,Kr=new Er(1,0,0),ts=new Er(0,1,0),es=new Er(0,0,1),rs={type:"added"},ss={type:"removed"};function is(){Object.defineProperty(this,"id",{value:Wr++}),this.uuid=Cr.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=is.DefaultUp.clone();const t=new Er,e=new Nr,r=new Ar,s=new Er(1,1,1);e._onChange((function(){r.setFromEuler(e,!1)})),r._onChange((function(){e.setFromQuaternion(r,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new kr},normalMatrix:{value:new Br}}),this.matrix=new kr,this.matrixWorld=new kr,this.matrixAutoUpdate=is.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new $r,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}is.DefaultUp=new Er(0,1,0),is.DefaultMatrixAutoUpdate=!0,is.prototype=Object.assign(Object.create(Dr.prototype),{constructor:is,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return qr.setFromAxisAngle(t,e),this.quaternion.multiply(qr),this},rotateOnWorldAxis:function(t,e){return qr.setFromAxisAngle(t,e),this.quaternion.premultiply(qr),this},rotateX:function(t){return this.rotateOnAxis(Kr,t)},rotateY:function(t){return this.rotateOnAxis(ts,t)},rotateZ:function(t){return this.rotateOnAxis(es,t)},translateOnAxis:function(t,e){return Vr.copy(t).applyQuaternion(this.quaternion),this.position.add(Vr.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(Kr,t)},translateY:function(t){return this.translateOnAxis(ts,t)},translateZ:function(t){return this.translateOnAxis(es,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4(Zr.getInverse(this.matrixWorld))},lookAt:function(t,e,r){t.isVector3?Gr.copy(t):Gr.set(t,e,r);const s=this.parent;this.updateWorldMatrix(!0,!1),Hr.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Zr.lookAt(Hr,Gr,this.up):Zr.lookAt(Gr,Hr,this.up),this.quaternion.setFromRotationMatrix(Zr),s&&(Zr.extractRotation(s.matrixWorld),qr.setFromRotationMatrix(Zr),this.quaternion.premultiply(qr.inverse()))},add:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(rs)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(ss)),this},attach:function(t){return this.updateWorldMatrix(!0,!1),Zr.getInverse(this.matrixWorld),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),Zr.multiply(t.parent.matrixWorld)),t.applyMatrix4(Zr),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(let r=0,s=this.children.length;r<s;r++){const s=this.children[r].getObjectByProperty(t,e);if(void 0!==s)return s}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new Er),this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new Ar),this.updateMatrixWorld(!0),this.matrixWorld.decompose(Hr,t,Jr),t},getWorldScale:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new Er),this.updateMatrixWorld(!0),this.matrixWorld.decompose(Hr,Qr,t),t},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new Er),this.updateMatrixWorld(!0);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);const e=this.children;for(let r=0,s=e.length;r<s;r++)e[r].traverse(t)},traverseVisible:function(t){if(!1===this.visible)return;t(this);const e=this.children;for(let r=0,s=e.length;r<s;r++)e[r].traverseVisible(t)},traverseAncestors:function(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let r=0,s=e.length;r<s;r++)e[r].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){const r=this.parent;if(!0===t&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,r=t.length;e<r;e++)t[e].updateWorldMatrix(!1,!0)}},toJSON:function(t){const e=void 0===t||"string"==typeof t,r={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const s={};function i(e,r){return void 0===e[r.uuid]&&(e[r.uuid]=r.toJSON(t)),r.uuid}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),!0===this.castShadow&&(s.castShadow=!0),!0===this.receiveShadow&&(s.receiveShadow=!0),!1===this.visible&&(s.visible=!1),!1===this.frustumCulled&&(s.frustumCulled=!1),0!==this.renderOrder&&(s.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){s.geometry=i(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const r=e.shapes;if(Array.isArray(r))for(let e=0,s=r.length;e<s;e++){const s=r[e];i(t.shapes,s)}else i(t.shapes,r)}}if(void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let r=0,s=this.material.length;r<s;r++)e.push(i(t.materials,this.material[r]));s.material=e}else s.material=i(t.materials,this.material);if(this.children.length>0){s.children=[];for(let e=0;e<this.children.length;e++)s.children.push(this.children[e].toJSON(t).object)}if(e){const e=n(t.geometries),s=n(t.materials),i=n(t.textures),o=n(t.images),a=n(t.shapes);e.length>0&&(r.geometries=e),s.length>0&&(r.materials=s),i.length>0&&(r.textures=i),o.length>0&&(r.images=o),a.length>0&&(r.shapes=a)}return r.object=s,r;function n(t){const e=[];for(const r in t){const s=t[r];delete s.metadata,e.push(s)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e){if(void 0===e&&(e=!0),this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const r=t.children[e];this.add(r.clone())}return this}});const{checkArg:ns,checkArgs:os}=Wt;class as extends wr{static defaultVariables(){return{atEdge:"wrap",hidden:!1}}constructor(){super(),Object.assign(this,as.defaultVariables())}agentConstructor(){this.obj3d=new is,this.obj3d.rotation.order="ZYX",this.reset()}reset(){this.obj3d.position.set(0,0,0),this.obj3d.rotation.set(0,0,0),this.heading=0}setxyz(t,e,r){os(arguments),super.setxy(t,e,r)}getxyz(){return this.obj3d.position.toArray()}setRotation(t,e,r){os(arguments),this.obj3d.rotation.set(t,e,r)}getRotation(){const{x:t,y:e,z:r}=this.obj3d.rotation;return[t,e,r]}getThetaPhiPsi(){return this.getRotation().reverse()}getHeadingPitchRoll(){const[t,e,r]=this.getRotation();return[O(r),A(-e),A(t)]}getDxDyDz(){return[this.dx,this.dy,this.dz]}get x(){return this.obj3d.position.x}set x(t){ns(t),this.obj3d.position.x=t}get y(){return this.obj3d.position.y}set y(t){ns(t),this.obj3d.position.y=t}get z(){return this.obj3d.position.z}set z(t){ns(t),this.obj3d.position.z=t}get theta(){return this.obj3d.rotation.z}set theta(t){ns(t),this.obj3d&&(this.obj3d.rotation.z=t)}get heading(){return this.model.fromRads(this.obj3d.rotation.z)}set heading(t){ns(t),this.obj3d.rotation.z=this.model.toRads(t)}get pitch(){return-this.model.fromAngleRads(this.obj3d.rotation.y)}set pitch(t){ns(t),this.obj3d.rotation.y=-this.model.toAngleRads(t)}get roll(){return this.model.fromAngleRads(this.obj3d.rotation.x)}set roll(t){ns(t),this.obj3d.rotation.x=this.model.toAngleRads(t)}forward(t){ns(t);const e=this.patch;this.obj3d.translateX(t),super.checkXYZ(e)}right(t){this.left(-t)}left(t){ns(t),this.obj3d.rotateZ(this.model.toAngleRads(t))}tiltUp(t){this.tiltDown(-t)}tiltDown(t){ns(t),this.obj3d.rotateY(this.model.toAngleRads(t))}rollRight(t){ns(t),this.obj3d.rotateX(this.model.toAngleRads(t))}rollLeft(t){this.rollRight(-t)}facexyz(t,e,r){os(arguments);const s=this.towardsXY(t,e),i=this.towardsPitchXYZ(t,e,r);this.heading=s,this.pitch=i}face(t){ns(t,"object");const{x:e,y:r,z:s}=t;this.facexyz(e,r,s)}towardsPitchXYZ(t,e,r){os(arguments);const[s,i,n]=this.getxyz(),[o,a,h]=[t-s,e-i,r-n],l=Math.hypot(o,a),c=Math.atan2(h,l);return this.model.fromAngleRads(c)}towardsPitch(t){ns(t,"object");const{x:e,y:r,z:s}=t;this.towardsPitchXYZ(e,r,s)}distance(t){ns(t,"object");const{x:e,y:r,z:s}=t;return this.distanceXYZ(e,r,s)}distanceXYZ(t,e,r){os(arguments);const{x:s,y:i,z:n}=this;return L(s,i,n,t,e,r)}get dx(){const{y:t,z:e}=this.obj3d.rotation;return Math.cos(t)*Math.cos(e)}get dy(){const{y:t,z:e}=this.obj3d.rotation;return Math.cos(t)*Math.sin(e)}get dz(){const t=this.obj3d.rotation.y;return Math.sin(t)}}class hs extends br{initAgentSet(t,e,r){"turtles"===t&&(r=as),super.initAgentSet(t,e,r)}}const ls={rgbaCssColor(t,e,r,s=255){const i=(s/=255).toPrecision(2);return 1===s?`rgb(${t},${e},${r})`:`rgba(${t},${e},${r},${i})`},hslCssColor(t,e=100,r=50,s=255){const i=(s/=255).toPrecision(4);return 1===s?`hsl(${t},${e}%,${r}%)`:`hsla(${t},${e}%,${r}%,${i})`},hexCssColor:(t,e,r)=>`#${(r|e<<8|t<<16|16777216).toString(16).slice(-6)}`,cssColor(t,e,r,s=255){return 255===s?this.hexCssColor(t,e,r):this.rgbaCssColor(t,e,r,s)},randomCssColor(){const t=()=>u(256);return this.cssColor(t(),t(),t())},randomGrayCssColor(t=0,e=255){const r=d(t,e);return this.cssColor(r,r,r)},cssToPixel(t){const e=this.cssToUint8Array(t);return this.rgbaToPixel(...e)},rgbaToPixel(t,e,r,s=255){const i=new Uint8Array([t,e,r,s]);return new Uint32Array(i.buffer)[0]},randomPixel(){const t=()=>u(256);return this.rgbaToPixel(t(),t(),t())},randomGrayPixel(t=0,e=255){const r=d(t,e);return this.rgbaToPixel(r,r,r)},sharedCtx1x1:Pt(1,1,!1,{willReadFrequently:!0}),cssToUint8Array(t){return this.sharedCtx1x1.clearRect(0,0,1,1),this.sharedCtx1x1.fillStyle=t,this.sharedCtx1x1.fillRect(0,0,1,1),this.sharedCtx1x1.getImageData(0,0,1,1).data},typedColor(t,e,r,s=255){if(void 0===e)return this.toTypedColor(t);const i=new Uint8ClampedArray([t,e,r,s]);return i.pixelArray=new Uint32Array(i.buffer),Object.setPrototypeOf(i,cs),i},isTypedColor:t=>t&&t.constructor===Uint8ClampedArray&&t.pixelArray,toTypedColor(t,e){if(this.isTypedColor(t))return t;const r=this.typedColor(0,0,0,0);if(null==e)if(pt(t))r.css=t;else if(yt(t))r.pixel=t;else if(ft(t))r.rgb=t;else{if(!vt(t))throw Error(`toTypedColor: illegal value ${t}`);r.rgb=t}else r[e]=t;return r},randomTypedColor(){const t=()=>u(256);return this.typedColor(t(),t(),t())},randomGrayTypedColor(t=0,e=255){const r=d(t,e);return this.typedColor(r,r,r)},randomColorArray(t){const e=new Array(t);return Z(e,((t,r)=>e[r]=this.randomTypedColor())),e},randomGrayArray(t,e=0,r=255){const s=new Array(t);return Z(s,((t,i)=>s[i]=this.randomGrayTypedColor(e,r))),s}},cs={__proto__:Uint8ClampedArray.prototype,setColor(t,e,r,s=255){this.checkColorChange(),this[0]=t,this[1]=e,this[2]=r,this[3]=s},set rgb(t){this.setColor(...t)},get rgb(){return this},setAlpha(t){this.checkColorChange(),this[3]=t},getAlpha(){return this[3]},get alpha(){return this.getAlpha()},set alpha(t){this.setAlpha(t)},setPixel(t){this.checkColorChange(),this.pixelArray[0]=t},getPixel(){return this.pixelArray[0]},get pixel(){return this.getPixel()},set pixel(t){this.setPixel(t)},setCss(t){return this.setColor(...ls.cssToUint8Array(t))},getCss(){return null==this.string&&(this.string=ls.cssColor(...this)),this.string},get css(){return this.getCss()},set css(t){this.setCss(t)},setWebgl(t){if(3!==t.length)throw Error("setWebgl array length must be 3, length:",t.length);this.setColor(255*t[0],255*t[1],255*t[2])},getWebgl(){return[this[0]/255,this[1]/255,this[2]/255]},get webgl(){return this.getWebgl()},set webgl(t){this.setWebgl(t)},checkColorChange(){this.string=null},equals(t){return this.getPixel()===t.getPixel()},toString(){return`[${Array.from(this).toString()}]`},rgbDistance(t,e,r){const[s,i,n]=this,o=Math.round((s+t)/2),[a,h,l]=[s-t,i-e,n-r],[c,u,d]=[a*a,h*h,l*l];return((512+o)*c>>8)+4*u+((767-o)*d>>8)}};function us(t){return"number"==typeof t?t:t.pixel?t.pixel:"transparent"===t?0:ls.toTypedColor(t).pixel}class ds{constructor(t,e){this.ctx=Pt(t,e),this.resetImageData(),this.useImageSmoothing=!1}resetImageData(){this.imageData=Ft(this.ctx),this.pixels=new Uint32Array(this.imageData.data.buffer)}setPatchesSmoothing(t){this.useImageSmoothing=t}setPixels(t,e=(t=>t)){if(ht(t)&&(t=ct(t)),t.length!==this.pixels.length)throw Error("setPixels, data.length != pixels.length "+t.length+" "+this.pixels.length);Z(t,((t,r)=>{this.pixels[r]=us(e(t))}))}createPixels(t){G(this.pixels.length,(e=>{this.pixels[e]=us(t(e))}))}setPixel(t,e){this.pixels[t]=us(e)}draw(t){const e=this.ctx.imageSmoothingEnabled;t.imageSmoothingEnabled=this.useImageSmoothing,this.ctx.putImageData(this.imageData,0,0),Lt(t,this.ctx.canvas),t.imageSmoothingEnabled=e}clear(t){if((t=t.css||t)&&"string"!=typeof t){if("number"!=typeof t)throw Error("patchesView.clear(): illegal color "+t);this.createPixels((()=>t))}else Dt(this.ctx,t);"number"==typeof t?this.updateCanvas():this.resetImageData()}getImageBitmap(t={}){return createImageBitmap(this.imageData,t)}drawImageBitmap(t,e={}){createImageBitmap(this.imageData,e).then((e=>Lt(t,e)))}updateCanvas(){return this.ctx.putImageData(this.imageData,0,0),this.ctx.canvas}}class ms extends Se{static rgbToInt24(t,e,r){return 256*t*256+256*e+r}static rgbScaleFunction(t,e){return(r,s,i)=>t+rgbToInt24(r,s,i)*e}constructor(t,e=ms.rgbToInt24,r=Float32Array){const{width:s,height:i}=t;super(s,i,new r(s*i));const n=Ft(Nt(t)),o=this.data;for(var a=0;a<o.length;a++){const t=n.data[4*a],r=n.data[4*a+1],s=n.data[4*a+2];o[a]=e(t,r,s)}}}let ps=null;function gs(t,e=!1,r="RGBA"){if(!ps){const t=Et(0,0);ps=t.getContext("webgl",{premultipliedAlpha:!1})}const{width:s,height:i}=t,n=ps;Object.assign(n.canvas,{width:s,height:i});const o=n[r],a=n.createTexture();n.bindTexture(n.TEXTURE_2D,a),e&&n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!0),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.NONE),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.texImage2D(n.TEXTURE_2D,0,o,o,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST);const h=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,h),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,a,0);const l=n.checkFramebufferStatus(n.FRAMEBUFFER);if(l!==n.FRAMEBUFFER_COMPLETE)throw Error(`imageToBytes: status not FRAMEBUFFER_COMPLETE: ${l}`);const c=new Uint8Array(("RGB"===r?3:4)*s*i);return n.readPixels(0,0,s,i,o,n.UNSIGNED_BYTE,c),n.bindFramebuffer(n.FRAMEBUFFER,null),c}var fs=Object.freeze({__proto__:null,imageToBytes:gs,default:class extends Se{constructor(t,e=Float32Array,r={}){const s=gs(t),i=new e(s.buffer);super(4*i.length/s.length*t.width,t.height,i),Object.assign(this,r),this.src=t.src}}});class ys extends Se{constructor(t,e,r,s){super(t,e,s),this.bbox=r}static viewFromDataSet(t,e){return new ys(t.width,t.height,e,t.data)}lat2y(t){const[e,r,s,i]=this.bbox;return Math.round(this.height*(t-r)/(i-r))}lon2x(t){const[e,r,s,i]=this.bbox;return Math.round(this.width*(t-e)/(s-e))}toPixel(t,e){return[this.lon2x(t),this.lat2y(e)]}getGeo(t,e){const[r,s]=this.toPixel(t,e);return this.getXY(r,s)}setGeo(t,e,r){const[s,i]=this.toPixel(t,e);return this.setXY(s,i,r)}sampleGeo(t,e,r=!0){const[s,i]=this.toPixel(t,e);return this.sample(s,i,r)}dzdx(){const[t,e]=cr(this.bbox),r=t/this.width,s=super.dzdx(2,1/8*(1/r));return ys.viewFromDataSet(s,this.bbox)}dzdy(){const[t,e]=cr(this.bbox),r=e/this.height,s=super.dzdy(2,1/8*(1/r));return ys.viewFromDataSet(s,this.bbox)}slopeAndAspect(){const t=this.dzdx(),e=this.dzdy();return{dzdx:t,dzdy:e,slope:this.slope(t,e),aspect:this.aspect(t,e)}}aspect(t=this.dzdx(),e=this.dzdy()){return t.map(((t,r)=>{const s=e.data[r];return Math.atan2(-s,-t)}))}slope(t=this.dzdx(),e=this.dzdy()){return t.map(((t,r)=>{const s=e.data[r],i=Math.hypot(-t,-s);return Math.PI/2-Math.atan2(1,i)}))}clone(){return new ys(this.width,this.height,this.bbox,this.data)}resample(t,e,r=!0,s=Array){const i=super.resample(t,e,r,s);return ys.viewFromDataSet(i,this.bbox)}convolve(t,e=1,r=!1){const s=super.convolve(t,e,r);return ys.viewFromDataSet(s,this.bbox)}normalize(t=0,e=1,r=!1){const s=super.normalize(t,e,r);return ys.viewFromDataSet(s,this.bbox)}map(t){const e=super.map(t);return ys.viewFromDataSet(e,this.bbox)}}function xs(t,e,r){return 256*t*256+256*e+r}function ws(t,e){return(r,s,i)=>t+xs(r,s,i)*e}function bs(t,e,r){let s=1;return t>63&&(s=-1,t=0),s*xs(t,e,r)/10}const Ms={zxyToTile:async function(t,e,r){const s=this.zxyUrl(t,e,r),i=await At(s);return i.zxy=[t,e,r],i},zxyToDataSet:async function(t,e,r,s=Float32Array){const i=await this.zxyToTile(t,e,r),n=this.tileDataSet(i,s),o=Qe(e,r,t),a=ys.viewFromDataSet(n,o);return a.zxy=[t,e,r],a},tileDataSet:function(t,e=Float32Array){const r=this.elevationFcn;return new ms(t,r,e)},tileSize:256},vs=Object.assign({elevationFcn:ws(-1e4,.1),zxyUrl:(t,e,r)=>`https://api.maptiler.com/tiles/terrain-rgb/${t}/${e}/${r}.png?key=iQurAP6lArV1UP4gfSVs`,zxyTemplate:"https://api.maptiler.com/tiles/terrain-rgb/{z}/{x}/{y}.png?key=iQurAP6lArV1UP4gfSVs",minZoom:0,maxZoom:15},Ms),zs=Object.assign({elevationFcn:ws(-32768,1/256),zxyUrl:(t,e,r)=>`https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${t}/${e}/${r}.png`,zxyTemplate:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",minZoom:0,maxZoom:15},Ms),_s=Object.assign({elevationFcn:bs,zxyUrl:(t,e,r)=>`https://s3-us-west-2.amazonaws.com/simtable-elevation-tiles/${t}/${e}/${r}.png`,zxyTemplate:"https://s3-us-west-2.amazonaws.com/simtable-elevation-tiles/{z}/{x}/{y}.png",minZoom:10,maxZoom:14},Ms),Ss=Object.assign({elevationFcn:bs,zxyUrl:(t,e,r)=>`https://s3-us-west-2.amazonaws.com/world-elevation-tiles/DEM_tiles/${t}/${e}/${r}.png`,zxyTemplate:"https://s3-us-west-2.amazonaws.com/world-elevation-tiles/DEM_tiles/{z}/{x}/{y}.png",minZoom:7,maxZoom:13},Ms),Cs="pk.eyJ1IjoiYmFja3NwYWNlcyIsImEiOiJjanVrbzI4dncwOXl3M3ptcGJtN3oxMmhoIn0.x9iSCrtm0iADEqixVgPwqQ",As=Object.assign({elevationFcn:ws(-1e4,.1),zxyUrl:(t,e,r)=>`https://api.mapbox.com/v4/mapbox.terrain-rgb/${t}/${e}/${r}.png?access_token=pk.eyJ1IjoiYmFja3NwYWNlcyIsImEiOiJjanVrbzI4dncwOXl3M3ptcGJtN3oxMmhoIn0.x9iSCrtm0iADEqixVgPwqQ`,zxyTemplate:"https://api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.png?access_token="+Cs,minZoom:0,maxZoom:18},Ms),Es=zs;var Ps=Object.freeze({__proto__:null,maptiler:vs,mapzen:zs,redfishUSA:_s,redfishWorld:Ss,mapbox:As,maplibre:Es});const Os={gradientImageData(t,e,r){const s=Pt(t,1);r||(r=it(0,1,e.length));const i=s.createLinearGradient(0,0,t,0);return G(e.length,(t=>i.addColorStop(r[t],e[t]))),s.fillStyle=i,s.fillRect(0,0,t,1),Yt(s)},arrayToTypedColors:t=>t.map((t=>ls.toTypedColor(t))),permuteArrays(t,e=t,r=t){const s=[];for(const i of r)for(const r of e)for(const e of t)s.push([e,r,i]);return s},permuteRGBColors(t,e=t,r=t){const s=[t,e,r].map((t=>nt(0,255,t)));return this.permuteArrays(...s)},ColorMapProto:{__proto__:Array.prototype,createIndex(){this.index=[],G(this.length,(t=>{const e=this[t].getPixel();this.index[e]=t,this.cssNames&&(this.index[this.cssNames[t]]=t)}))},randomColor(){return this[u(this.length)]},setAlpha(t){Z(this,(e=>e.setAlpha(t)))},clone(){return this.cloneColorMap(this)},atIndex(t){return this[t%this.length]},indexOf(t){if(this.index)return this.index[t.getPixel()];for(let e=0;e<this.length;e++)if(t.equals(this[e]))return e},scaleColor(t,e=0,r=this.length-1){if(e===r)return this[e];const s=z(t,e,r);return this[Math.round(v(0,this.length-1,s))]},toString(){return`${this.length} ${q(this)}`},rgbClosestIndex(t,e,r){let s=1/0,i=0;for(var n=0;n<this.length;n++){const o=this[n].rgbDistance(t,e,r);if(o<s&&(s=o,i=n,0===o))return i}return i},rgbClosestColor(t,e,r){return this[this.rgbClosestIndex(t,e,r)]},cubeClosestIndex(t,e,r){const s=this.cube;if(!s)throw Error("cubeClosestIndex: requires the cube arrays");const i=s.map((t=>255/(t-1))),n=[t,e,r].map(((t,e)=>Math.round(t/i[e]))),[o,a,h]=n;return o+a*s[0]+h*s[0]*s[1]},cubeClosestColor(t,e,r){return this[this.cubeClosestIndex(t,e,r)]},closestIndex(t,e,r){return this.cube?this.cubeClosestIndex(t,e,r):this.rgbClosestIndex(t,e,r)},closestColor(t,e,r){return this[this.closestIndex(t,e,r)]}},basicColorMap(t){return t=this.arrayToTypedColors(t),Object.setPrototypeOf(t,this.ColorMapProto),t},grayColorMap(t=0,e=255,r=e-t+1){const s=nt(t,e,r);return this.basicColorMap(s.map((t=>[t,t,t])))},rgbColorCube(t,e=t,r=t){const s=this.permuteRGBColors(t,e,r),i=this.basicColorMap(s);return i.cube=[t,e,r],i},rgbColorMap(t,e,r){const s=this.permuteArrays(t,e,r);return this.basicColorMap(s)},hslColorMap(t=360,e=100,r=50){const s=nt(1,360,t).map((t=>ls.hslCssColor(t))).map((t=>ls.toTypedColor(t)));return this.basicColorMap(s)},transparentColorMap(t=1){return this.staticColorMap(0,t)},staticColorMap(t,e=1){t=ls.toTypedColor(t);const r=Array(e).fill(t);return this.basicColorMap(r)},gradientColorMap(t,e,r){e=e.map((t=>t.css||t));const s=this.gradientImageData(t,e,r),i=this.arrayToTypedColors(s);return Object.setPrototypeOf(i,this.ColorMapProto),i},jetColors:["rgb(0, 0, 127)","rgb(0, 0, 255)","rgb(0, 127, 255)","rgb(0, 255, 255)","rgb(127, 255, 127)","rgb(255, 255, 0)","rgb(255, 127, 0)","rgb(255, 0, 0)","rgb(127, 0, 0)"],basicColorNames:"white silver gray black red maroon yellow orange olive lime green cyan teal blue navy magenta purple".split(" "),brightColorNames:"white silver red maroon yellow orange olive lime green cyan teal blue navy magenta purple".split(" "),cssColorMap(t,e=!1){const r=t.map((t=>ls.cssToUint8Array(t))),s=this.basicColorMap(r);return s.cssNames=t,e&&(t.forEach(((t,e)=>{s[t]=s[e]})),s.cyan&&(s.aqua=s.cyan),s.magenta&&(s.fuchsia=s.magenta)),s},cloneColorMap(t){const e=Object.keys(t),r=this.basicColorMap(t);return Z(e,((e,s)=>{void 0===r[s]&&(r[e]=t[e])})),r},LazyMap(t,e){return Object.defineProperty(this,t,{value:e,enumerable:!0}),e},get Gray(){return this.LazyMap("Gray",this.grayColorMap())},get Hue(){return this.LazyMap("Hue",this.hslColorMap())},get LightGray(){return this.LazyMap("LightGray",this.grayColorMap(200))},get DarkGray(){return this.LazyMap("DarkGray",this.grayColorMap(0,100))},get Jet(){return this.LazyMap("Jet",this.gradientColorMap(256,this.jetColors))},get Rgb256(){return this.LazyMap("Rgb256",this.rgbColorCube(8,8,4))},get Rgb(){return this.LazyMap("Rgb",this.rgbColorCube(16))},get Transparent(){return this.LazyMap("Transparent",this.transparentColorMap())},get Basic16(){return this.LazyMap("Basic16",this.cssColorMap(this.basicColorNames,!0))}};function ks(t){return t&&t.css||t}class Is{constructor(){this.cache={},this.paths=js}addPath(t,e){this.getPath(t),js[t]=e}needsStrokeColor(t){return t.endsWith("2")}getPathNames(){return Object.keys(js)}getPath(t){return js[t]}oneOf(){return et(js)}nameAtIndex(t){const e=this.getPathNames();return e[x(t,e.length)]}atIndex(t){const e=this.nameAtIndex(t);return js[e]}imagePathPromise(t,e){return At(e).then((e=>{this.createImagePath(t,e)}))}createImagePath(t,e,r=!0){if(!Mt(e))throw Error("Shapes createImagePath: img not an imageable "+e);r&&(e=function(t){const{width:e,height:r}=t,s=Pt(e,r);return s.scale(1,-1),s.drawImage(t,0,-r),s.canvas}(e)),this.addPath(t,(function(t){t.drawImage(e,-.5,-.5,1,1)}))}imageName(t,e,r,s){const i=this.getPath(t);if(!Number.isInteger(e))throw Error(`imageName: pixels is not integer: ${t}`);if(!i)throw Error(`imageName: ${t} not in Shapes`);if("imagePath"===i.name)return`${t}_${e}_image`;if(!r)throw Error(`imageName: No color for shape ${t}`);return this.needsStrokeColor(t)||(s=null),`${t}_${e}_${r}${s?`_${s}`:""}`}shapeToImage(t,e,r,s){e=Math.ceil(e);const i=this.imageName(t,e,r,s);if(this.cache&&this.cache[i])return this.cache[i];const n=Pt(e,e);return n.fillStyle=ks(r),n.strokeStyle=ks(s),n.scale(e,-e),n.translate(.5,-.5),n.beginPath(),js[t](n),n.closePath(),n.fill(),n.canvas.name=i,this.cache&&(this.cache[i]=n.canvas),n.canvas}imageNameToImage(t){const[e,r,s,i]=t.split("_");return this.shapeToImage(e,r,s,i)}}function Ts(t,e){e.forEach(((e,r)=>{0===r?t.moveTo(e[0],e[1]):t.lineTo(e[0],e[1])}))}function Rs(t,e,r,s,i=!1){t.arc(e,r,s,0,2*Math.PI,i)}function Xs(t,e,r,s){t.fillRect(e-s/2,r-s/2,s,s)}const js={arrow(t){Ts(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])},bug(t){t.strokeStyle=t.fillStyle,this.bug2(t)},bug2(t){t.lineWidth=.05,Ts(t,[[.4,.225],[.2,0],[.4,-.225]]),t.stroke(),t.beginPath(),Rs(t,.12,0,.13),Rs(t,-.05,0,.13),Rs(t,-.27,0,.2)},circle(t){Rs(t,0,0,.5)},dart(t){Ts(t,[[.5,0],[-.5,.4],[-.25,0],[-.5,-.4]])},frame(t){const e=.3;Ts(t,[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]]),t.closePath(),Ts(t,[[-e,-e],[-e,e],[e,e],[e,-e]])},frame2(t){Xs(t,0,0,1),t.fillStyle=t.strokeStyle,Xs(t,0,0,.6)},person(t){t.strokeStyle=t.fillStyle,this.person2(t)},person2(t){Ts(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),t.fill(),t.beginPath(),t.fillStyle=t.strokeStyle,Rs(t,0,.35,.15)},ring(t){const[e,r]=[.5,.3];Rs(t,0,0,e),t.lineTo(r,0),Rs(t,0,0,r,!0)},ring2(t){const[e,r]=[.5,.3];Rs(t,0,0,e),t.closePath(),t.fill(),t.beginPath(),t.fillStyle=t.strokeStyle,Rs(t,0,0,r)},square(t){Xs(t,0,0,1)},triangle(t){Ts(t,[[.5,0],[-.5,-.4],[-.5,.4]])}};class Fs{constructor(t=64,e=16,r=!1){t=Math.ceil(t),Object.assign(this,{spriteSize:t,cols:e,usePowerOf2:r}),this.rows=1,this.nextCol=0,this.nextRow=0,this.spritesIndex={},this.sprites=[],this.shapes=new Is,r&&this.checkPowerOf2(),this.ctx=Pt(this.width,this.height),this.texture=null}getSprite(t,e,r){return this.newSprite(t,e,r)}oneOf(){return Q(this.sprites)}draw(t,e,r,s,i,n,o,a=!1){const[h,l]=n.patchXYtoPixelXY(r,s,o),c=-i;this.drawCanvas(t,e,h,l,c,a)}drawCanvas(t,e,r,s,i=0,n=!1){const{x:o,y:a,size:h}=e,l=h/2;n&&(i=0),0===i?t.drawImage(this.ctx.canvas,o,a,h,h,r-l,s-l,h,h):(t.save(),t.translate(r,s),t.rotate(i),t.drawImage(this.ctx.canvas,o,a,h,h,-l,-l,h,h),t.restore())}newSprite(t,e,r=null){const s=this.shapes.imageName(t,this.spriteSize,e,r);if(this.spritesIndex[s])return this.spritesIndex[s];const i=this.shapes.shapeToImage(t,this.spriteSize,e,r);this.checkSheetSize();const[n,o,a]=[this.nextX,this.nextY,this.spriteSize];this.ctx.drawImage(i,n,o,a,a);const{nextRow:h,nextCol:l}=this,c={name:s,id:this.sprites.length,x:n,y:o,row:h,col:l,size:a,sheet:this};return c.uvs=this.getUVs(c),this.incrementRowCol(),this.spritesIndex[s]=c,this.sprites.push(c),this.texture&&(this.texture.needsUpdate=!0),c}get width(){return this.spriteSize*this.cols}get height(){return this.spriteSize*this.rows}get nextX(){return this.spriteSize*this.nextCol}get nextY(){return this.spriteSize*this.nextRow}checkPowerOf2(){const{width:t,height:e}=this;if(!y(t)||!y(e))throw Error(`SpriteSheet non power of 2: ${t}x${e}`)}checkSheetSize(){this.nextRow===this.rows&&(this.rows=this.usePowerOf2?2*this.rows:this.rows+1,kt(this.ctx,this.width,this.height),Z(this.sprites,(t=>{t.uvs=this.getUVs(t)})))}incrementRowCol(){this.nextCol+=1,this.nextCol<this.cols||(this.nextCol=0,this.nextRow+=1)}getUVs(t){const{row:e,col:r}=t,{rows:s,cols:i}=this,n=r/i,o=(s-(e+1))/s,a=(r+1)/i,h=(s-e)/s;return[n,o,a,o,a,h,n,h]}}function Ys(t){return t&&t.css||t}class Ds{static defaultOptions(){return{useSprites:!1,patchSize:10}}constructor(t,e,r={}){r=Object.assign(Ds.defaultOptions(),r),Object.assign(this,{ctx:t,world:e},r),this.shapes=new Is,this.reset(this.patchSize,this.useSprites)}reset(t,e=this.useSprites){this.useSprites=e,this.resetCtx(t)}getImageBitmap(){return createImageBitmap(this.ctx.canvas)}resetCtx(t){this.patchSize=t,this.useSprites?(this.world.setCanvasSize(this.ctx.canvas,t),this.ctx.restore()):this.world.setEuclideanTransform(this.ctx,t)}drawTurtles(t,e){ht(t)&&(t=ct(t));const r=gt(e);Z(t,((s,i)=>{const n=r?e:e(s,i,t);this.drawTurtle(s,n)}))}drawTurtle(t,e){if(!t.hidden&&0!==e.size)if(this.useSprites){let{sprite:r,noRotate:s}=e;if(!r){const{shape:t,color:s,strokeColor:i,size:n}=e,o=n*this.patchSize;r=this.shapes.shapeToImage(t,o,s,i)}r.sheet?r.sheet.draw(this.ctx,r,t.x,t.y,t.theta,this.world,this.patchSize,s):this.drawImage(r,t.x,t.y,s?0:t.theta)}else{const{shape:r,color:s,strokeColor:i,size:n,noRotate:o}=e;this.drawShape(r,t.x,t.y,o?0:t.theta,n,s,i)}}drawShape(t,e,r,s=0,i=1,n,o){const a=this.ctx;a.save(),a.fillStyle=Ys(n),a.strokeStyle=Ys(o),a.translate(e,r),a.scale(i,i),0!==s&&a.rotate(s),a.beginPath(),this.shapes.paths[t](a),a.closePath(),a.fill(),a.restore()}drawImage(t,e,r,s=0){const i=t.width/2,n=this.patchSize,[o,a]=this.world.patchXYtoPixelXY(e,r,n),h=this.ctx;0===s?h.drawImage(t,o-i,a-i):(h.save(),h.translate(o,a),h.rotate(-s),h.drawImage(t,-i,-i),h.restore())}drawLinks(t,e){ht(t)&&(t=ct(t));const r=gt(e),s=this.ctx;Tt(this.ctx),r&&(s.strokeStyle=Ys(e.color),s.lineWidth=e.width||1,s.beginPath()),Z(t,((s,i)=>{if(r)this.drawLink(s);else{const{color:r,width:n}=e(s,i,t);this.drawLink(s,r,n)}})),r&&(s.closePath(),s.stroke()),this.ctx.restore()}drawLink(t,e,r=1){this.drawLine(t.x0,t.y0,t.x1,t.y1,e,r)}drawLine(t,e,r,s,i,n=1){const o=this.ctx;[t,e]=this.world.patchXYtoPixelXY(t,e,this.patchSize),[r,s]=this.world.patchXYtoPixelXY(r,s,this.patchSize),i&&(o.strokeStyle=Ys(i),o.lineWidth=n,o.beginPath()),o.moveTo(t,e),o.lineTo(r,s),i&&(o.closePath(),o.stroke())}}class Ns{static defaultOptions(){return{div:document.body,useSprites:!1,patchSize:10}}constructor(t,e={}){t.world&&(t=t.world),(e=Object.assign(Ns.defaultOptions(),e)).width&&(e.patchSize=e.width/t.width,delete e.width);let r=e.div,s=r;r=pt(r)?document.getElementById(r):r,bt(s)||(s=Et(0,0,!0),r.appendChild(s)),this.ctx=s.getContext("2d"),this.world=t,this.patchesView=new ds(this.world.width,this.world.height),this.turtlesView=new Ds(this.ctx,this.world,e),this.ticks=0,this.clear()}tick(){this.ticks++}get canvas(){return this.ctx.canvas}reset(t,e=this.useSprites){this.turtlesView.reset(t,e)}downloadCanvas(t){t||(t=this.model.constructor.name.toLowerCase().replace(/model$/,"")),Ct(this.canvas,t)}get width(){return this.world.width*this.patchSize}set width(t){this.reset(t/this.world.width)}get patchSize(){return this.turtlesView.patchSize}set patchSize(t){this.reset(t)}get useSprites(){return this.turtlesView.useSprites}set useSprites(t){this.reset(this.patchSize,t)}clear(t){Dt(this.ctx,t)}createPatchPixels(t){this.patchesView.createPixels(t)}setPatchPixel(t,e){this.patchesView.setPixel(t,e)}setPatchesPixels(t,e){this.patchesView.setPixels(t,e)}setPatchesSmoothing(t){this.patchesView.setPatchesSmoothing(t)}drawPatchesImage(t){Lt(this.ctx,t)}drawPatches(t,e){null!=t&&this.patchesView.setPixels(t,e),this.patchesView.draw(this.ctx)}drawTurtles(t,e){this.turtlesView.drawTurtles(t,e)}drawLinks(t,e){this.turtlesView.drawLinks(t,e)}setTextProperties(t,e="center",r="middle"){"number"==typeof t&&(t=this.patchSize*t+"px sans-serif"),Rt(this.ctx,t,e,r)}drawText(t,e,r,s="black"){[e,r]=this.world.patchXYtoPixelXY(e,r,this.patchSize),t=""+t,jt(this.ctx,t,e,r,s)}}class Ls extends Ns{static defaultOptions(t){return{patchesColor:"random",initPatches:null,turtles:t.turtles,turtlesColor:"random",turtlesStrokeColor:"random",turtlesShape:"dart",turtlesSize:1,turtlesRotate:!0,links:t.links,linksColor:"random",linksWidth:1,textProperty:null,textSize:.5,textColor:"black",patchesMap:"DarkGray",turtlesMap:"Basic16"}}static separateDrawOptions(t,e){return t.drawOptions&&(Object.assign(e,t.drawOptions),delete t.drawOptions),e}constructor(t,e={},r={}){r=Ls.separateDrawOptions(e,r),r=Object.assign(Ls.defaultOptions(t),r),super(t,e),this.model=t,this.checkOptions(r),this.drawOptions=r}checkOptions(t){const e=Object.keys(t),r=Ls.defaultOptions(this.model);e.forEach((t=>{if(void 0===r[t])throw console.log("Legal TwoDraw parameters",Object.keys(Ls.defaultOptions(this.model))),Error("Unknown TwoDraw parameter: "+t)})),"string"==typeof t.patchesMap&&(t.patchesMap=Os[t.patchesMap],t.patchesMap||Error("Unknown patchMap: "+t.patchesMap)),"string"==typeof t.turtlesMap&&(t.turtlesMap=Os[t.turtlesMap],t.turtlesMap||Error("Unknown turtlesMap: "+t.turtlesMap))}resetOptions(t=this.drawOptions){return this.checkOptions(t),this.drawOptions=t,this.ticks=0,t}draw(){const t=this.model,e=this;let{patchesColor:r,initPatches:s,turtles:i,turtlesColor:n,turtlesStrokeColor:o,turtlesShape:a,turtlesSize:h,turtlesRotate:l,links:c,linksColor:u,linksWidth:d,textProperty:m,textSize:p,textColor:g,patchesMap:f,turtlesMap:y}=this.drawOptions;if(0===e.ticks)if(m&&e.setTextProperties(p),s){const r=s(t,e);e.createPatchPixels((t=>r[t]))}else"random"===r&&e.createPatchPixels((t=>f.randomColor()));"random"===r||s?(e.clear(),e.drawPatches()):"function"==typeof r?e.drawPatches(t.patches,(t=>r(t))):Mt(r)?e.drawPatchesImage(r):e.clear(r);const x=(t,e)=>"random"===e?y.atIndex(t.id).css:e;e.drawLinks(c,(t=>({color:"random"===u?y.atIndex(t.id):"function"==typeof u?x(t,u(t)):u,width:d}))),e.drawTurtles(i,(t=>({shape:"function"==typeof a?a(t):a,color:"random"===n?y.atIndex(t.id).css:"function"==typeof n?x(t,n(t)):n,strokeColor:"random"===o?y.atIndex(t.id+4).css:"function"==typeof n?x(t,n(t)):n,size:"function"==typeof h?h(t):h,noRotate:"function"==typeof l?!l(t):!l}))),m&&i.ask((t=>{null!=t[m]&&e.drawText(t[m],t.x,t.y,g)})),e.tick()}}var Us=function(){var t=0,e=document.createElement("div");function r(t){return e.appendChild(t.dom),t}function s(r){for(var s=0;s<e.children.length;s++)e.children[s].style.display=s===r?"block":"none";t=r}e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",(function(r){r.preventDefault(),s(++t%e.children.length)}),!1);var i=(performance||Date).now(),n=i,o=0,a=r(new Us.Panel("FPS","#0ff","#002")),h=r(new Us.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=r(new Us.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:e,addPanel:r,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){o++;var t=(performance||Date).now();if(h.update(t-i,200),t>=n+1e3&&(a.update(1e3*o/(t-n),100),n=t,o=0,l)){var e=performance.memory;l.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return t},update:function(){i=this.end()},domElement:e,setMode:s}};Us.Panel=function(t,e,r){var s=1/0,i=0,n=Math.round,o=n(window.devicePixelRatio||1),a=80*o,h=48*o,l=3*o,c=2*o,u=3*o,d=15*o,m=74*o,p=30*o,g=document.createElement("canvas");g.width=a,g.height=h,g.style.cssText="width:80px;height:48px";var f=g.getContext("2d");return f.font="bold "+9*o+"px Helvetica,Arial,sans-serif",f.textBaseline="top",f.fillStyle=r,f.fillRect(0,0,a,h),f.fillStyle=e,f.fillText(t,l,c),f.fillRect(u,d,m,p),f.fillStyle=r,f.globalAlpha=.9,f.fillRect(u,d,m,p),{dom:g,update:function(h,y){s=Math.min(s,h),i=Math.max(i,h),f.fillStyle=r,f.globalAlpha=1,f.fillRect(0,0,a,d),f.fillStyle=e,f.fillText(n(h)+" "+t+" ("+n(s)+"-"+n(i)+")",l,c),f.drawImage(g,u+o,d,m-o,p,u,d,m-o,p),f.fillRect(u+m-o,d,o,p),f.fillStyle=r,f.globalAlpha=.9,f.fillRect(u+m-o,d,o,n((1-h/y)*p))}}};class $s{constructor(t,e=-1,r=30){Object.assign(this,{fcn:t,steps:e,fps:r,timeoutID:null,ticks:0}),this.start()}start(){if(!this.timeoutID)return this.timeoutID=setInterval((()=>this.step()),1e3/this.fps),this}stop(){return this.timeoutID&&clearInterval(this.timeoutID),this.timeoutID=null,this}step(){return this.ticks===this.steps?this.stop():(this.ticks++,this.fcn(),this.stats&&this.stats.update(),this)}isRunning(){return null!=this.timeoutID}startStats(t="0px"){return this.stats?console.log("startStats: already running"):(this.stats=new Us,document.body.appendChild(this.stats.dom),this.stats.dom.style.left=t,this)}setFps(t){this.reset(this.steps,t)}setSteps(t){this.reset(t,this.fps)}reset(t=this.steps,e=this.fps){this.stop(),this.steps=t,this.ticks=0,this.fps=e,this.start()}toggle(){this.timeoutID?this.stop():0===this.steps?this.reset():this.start()}once(){this.stop(),this.step()}}class Bs{events={};on(t,e){return this.events[t]||(this.events[t]=[]),this.events[t].push(e),e}off(t,e=null){this.events[t]&&(e&&(this.events[t]=this.events[t].filter((t=>t!==e))),0!==this.events[t].length&&e||delete this.events[t])}emit(t,...e){this.events[t]&&this.events[t].forEach((t=>t(...e)))}}class Ws{constructor(t,e,r=((t,e)=>{})){"string"==typeof t&&(t=document.getElementById(t)),Object.assign(this,{canvas:t,world:e,callback:r}),this.mouseDown=t=>this.handleMouseDown(t),this.mouseUp=t=>this.handleMouseUp(t),this.mouseMove=t=>this.handleMouseMove(t)}resetParams(){this.x=this.y=NaN,this.moved=this.down=!1}start(){return this.canvas.addEventListener("mousedown",this.mouseDown),document.body.addEventListener("mouseup",this.mouseUp),this.canvas.addEventListener("mousemove",this.mouseMove),this.resetParams(),this}stop(){return this.canvas.removeEventListener("mousedown",this.mouseDown),document.body.removeEventListener("mouseup",this.mouseUp),this.canvas.removeEventListener("mousemove",this.mouseMove),this.resetParams(),this}get running(){return!isNaN(this.x)}run(t=!0){t?this.start():this.stop()}generalHandler(t,e,r){this.down=e,this.moved=r,this.setXY(t),this.callback(this,t)}handleMouseDown(t){this.action="down",this.generalHandler(t,!0,!1)}handleMouseUp(t){this.action="up",this.generalHandler(t,!1,!1)}handleMouseMove(t){this.action=this.down?"drag":"move",this.generalHandler(t,this.down,!0)}setXY(t){const{canvas:e,world:r}=this,s=r.patchSize(e),i=this.canvas.getBoundingClientRect(),n=t.clientX-i.left,o=t.clientY-i.top;[this.x,this.y]=r.pixelXYtoPatchXY(n,o,s)}}function Vs(t){return JSON.parse(JSON.stringify(t))}function qs(t,e=!0){e&&(t=Vs(t));return(t.features||t).reduce(((t,e)=>{const r=e.geometry;return"LineString"===r.type?(r.coordinates.properties=e.properties,t.push(r.coordinates)):"MultiLineString"===r.type&&r.coordinates.forEach((r=>{r.properties=e.properties,t.push(r)})),t}),[])}function Zs(t){switch(t.type){case"Point":return[t.coordinates];case"LineString":case"MultiPoint":return t.coordinates;case"Polygon":case"MultiLineString":return t.coordinates.reduce((function(t,e){return t.concat(e)}),[]);case"MultiPolygon":return t.coordinates.reduce((function(t,e){return t.concat(e.reduce((function(t,e){return t.concat(e)}),[]))}),[]);case"Feature":return Zs(t.geometry);case"GeometryCollection":return t.geometries.reduce((function(t,e){return t.concat(Zs(e))}),[]);case"FeatureCollection":return t.features.reduce((function(t,e){return t.concat(Zs(e))}),[])}}var Gs=Object.freeze({__proto__:null,isGeojson:function(t){return"object"==typeof t&&"FeatureCollection"===t.type},clone:Vs,minify:function(t){return"string"==typeof t&&(t=JSON.parse(t)),JSON.stringify(t).replace(/},{/g,"},\n\n{")},bboxFeature:function(t,e={}){const r=tr(t);return r.push(r[0]),{type:"Feature",geometry:{cordinates:r,type:"Polygon"},properties:e}},flattenMultiLineStrings:qs,lineStringsToLinks:function(t,e,r){const s=t.world.xfm||t.world.bboxTransform(...e);r=qs(r);const i={},n=[],o=[];function a(e){const r=e.toString();let o=i[r];return o||(o=t.turtles.createOne((t=>{t.setxy(...s.toWorld(e)),t.lon=e[0],t.lat=e[1]})),i[r]=o,n.push(o),o)}function h(e){e.reduce(((r,s,i,n)=>{const h=function(e,r){const s=a(e),i=a(r),n=t.links.createOne(s,i);return o.push(n),n}(n[i-1],s);return 1===i?(r=[h]).properties=e.properties:r.push(h),h.lineString=r,r}))}return r.forEach((t=>h(t))),[n,o]},flatten:function t(e,r=!0){switch(r&&(e=Vs(e)),e&&e.type||null){case"FeatureCollection":return e.features=e.features.reduce((function(e,r){return e.concat(t(r))}),[]),e;case"Feature":return e.geometry?t(e.geometry).map((function(t){var r={type:"Feature",properties:JSON.parse(JSON.stringify(e.properties)),geometry:t};return void 0!==e.id&&(r.id=e.id),r})):[e];case"MultiPoint":return e.coordinates.map((function(t){return{type:"Point",coordinates:t}}));case"MultiPolygon":return e.coordinates.map((function(t){return{type:"Polygon",coordinates:t}}));case"MultiLineString":return e.coordinates.map((function(t){return{type:"LineString",coordinates:t}}));case"GeometryCollection":return e.geometries.map(t).reduce((function(t,e){return t.concat(e)}),[]);case"Point":case"Polygon":case"LineString":return[e]}},geojsonBBox:function(t){var e,r;if(t.hasOwnProperty("type"))return e=Zs(t),r=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],e.reduce((function(t,e){return[Math.min(e[0],t[0]),Math.min(e[1],t[1]),Math.max(e[0],t[2]),Math.max(e[1],t[3])]}),r)},getCoordinates:Zs});export{ve as AgentArray,ze as AgentList,_e as AgentSet,$s as Animator,ls as Color,Os as ColorMap,Se as DataSet,Bs as Evented,gr as GeoWorld,Ce as Link,Ae as Links,br as Model,hs as Model3D,Ws as Mouse,is as Object3D,yr as Patch,fr as Patches,ds as PatchesView,fs as RGBADataSet,ms as RGBDataSet,Is as Shapes,Fs as SpriteSheet,Ps as TileData,wr as Turtle,as as Turtle3D,xr as Turtles,Ds as TurtlesView,Ls as TwoDraw,Ns as TwoView,Ee as World,Gs as geojson,pr as gis,Gt as steg,Me as turfImports,Wt as utils};
